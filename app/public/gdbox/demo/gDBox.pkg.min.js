!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.gDBox=e()}(this,function(){"use strict";var n,o=function(){};n=!1,o.extend=function(t){var i=null;function e(){n||(i&&(this._superprototype=i.prototype),this.init.apply(this,arguments))}for(var r in this!==o&&(i=this),i&&(n=!0,(e.prototype=new i).constructor=e,n=!1),e.extend=o.extend,t)t.hasOwnProperty(r)&&(e.prototype[r]=i&&"function"==typeof t[r]&&"function"==typeof e.prototype[r]&&/\b_super\b/.test(t[r])?function(t,e){return function(){return this._super=i.prototype[t],e.apply(this,arguments)}}(r,t[r]):t[r]);return e};var C={};function T(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function I(t,e,i){var r=t.activeFeature,n=t.activePoint,o=r.points[n.relationNodesIndex[0]],s=r.points[n.relationNodesIndex[1]],a=Math.sqrt((o.x-s.x)*(o.x-s.x)+(o.y-s.y)*(o.y-s.y)),l=(o.y-s.y)/a,h=(o.x-s.x)/a;return 1===l&&0===h||-1===l&&0===h?{dltx:e,dlty:0}:0===l&&1===h||0===l&&-1===h?{dltx:0,dlty:i}:{dltx:0,dlty:0}}function F(t){var e=t.activeFeature,i=t.activePoint,r=e.points[i.relationNodesIndex[0]],n=e.points[i.index],o=Math.sqrt((r.x-n.x)*(r.x-n.x)+(r.y-n.y)*(r.y-n.y)),s=(r.y-n.y)/o,a=(r.x-n.x)/o;return 0===s&&1===a||0===s&&-1===a?{flag:"y"}:{flag:"x"}}return C.config={version:"1.1.0"},C.Util={},C.Util.createDiv=function(t,e,i,r){var n=document.createElement("div");return n.id=t,n.style.width=e+"px",n.style.height=i+"px",r&&(n.style.position="absolute"),n.style.zIndex=1,n},C.Util.getDpr=function(){return window.devicePixelRatio||1},C.Util.createCanvas=function(t,e,i,r){var n=document.createElement("canvas"),o=C.Util.getDpr();return n.id=t,n.width=e*o,n.height=i*o,n.style.width=e+"px",n.style.height=i+"px",r&&(n.style.position="absolute"),n},C.Util.transformScreenXYWithDpr=function(t){var e=C.Util.getDpr();return{x:t.x*e,y:t.y*e}},C.Util.isInArray=function(t,e){for(var i in t)if(t[i]===e)return!0;return!1},C.Util.isObjInArray=function(t,e){for(var i in t)if(t[i].id===e.id)return alert("已被添加，请更换图层id"+e.id),!0;return!1},C.Util.setStyle=function(t,e){var i=C.Util.getDpr();return t.fillStyle=e.fillColor,t.strokeStyle=e.strokeColor,t.lineWidth=e.lineWeight*i,t.globalAlpha=e.opacity,!0},C.Util.worldToScreen=function(t,e,i){var r=t.getCenter(),n=r.x,o=r.y,s=parseInt(t.w,10)/2,a=parseInt(t.h,10)/2,l=t.zoom/parseInt(t.w,10);return{x:parseFloat(s)+parseFloat((e-n)/l)+0,y:parseFloat(a)-parseFloat((i-o)/l)+0}},C.Util.worldToScreenDistance=function(t,e,i){var r=t.zoom/parseInt(t.w,10);return{w:parseFloat(e/r),h:parseFloat(i/r)}},C.Util.screenToWorld=function(t,e,i){var r=t.getCenter(),n=r.x,o=r.y,s=parseInt(t.w,10)/2,a=parseInt(t.h,10)/2,l=t.zoom/parseInt(t.w,10);return{x:parseFloat(n)+parseFloat((e-s)*l),y:parseFloat(o)-parseFloat((i-a)*l)}},C.Util.addEvtHandler=function(t,e,i){t["on"+e]=i,"mousewheel"===e&&0===C.Util.getIEVersion()&&t.addEventListener("DOMMouseScroll",i,!1)},C.Util.removeEvtHandler=function(t,e){t["on"+e]=null},C.Util.getMouseXY=function(t,e){var i=0,r=0,n=e.srcElement?e.srcElement:e.target;if(1!==n.nodeType)return{x:i,y:r};if(document.attachEvent){var o="medium"===C.Util.getEleStyle(n,"border-top-width")?0:C.Util.delpx(C.Util.getEleStyle(n,"border-top-width")),s="medium"===C.Util.getEleStyle(n,"border-left-width")?0:C.Util.delpx(C.Util.getEleStyle(n,"border-left-width"));i=e.layerX-s,r=e.layerY-o}else{for(;n&&n!==t;){var a="medium"===C.Util.getEleStyle(n,"border-top-width")?0:C.Util.delpx(C.Util.getEleStyle(n,"border-top-width")),l="medium"===C.Util.getEleStyle(n,"border-left-width")?0:C.Util.delpx(C.Util.getEleStyle(n,"border-left-width"));i+=n.offsetLeft+l,r+=n.offsetTop+a,n=n.offsetParent}i=e.offsetX+i+document.body.scrollLeft,r=e.offsetY+r+document.body.scrollTop}return{x:i,y:r}},C.Util.getMousePos=function(t){var e=t||window.event;return{x:e.screenX,y:e.screenY}},C.Util.getEleStyle=function(t,e){var i=e.split("-"),r=i[0];if(1<r.length)for(var n=1;n<i.length;n++)r+=i[n].substring(0,1).toUpperCase()+i[n].substring(1);else r=e;return t.currentStyle?t.currentStyle[r]:document.defaultView.getComputedStyle(t,!1)[r]},C.Util.delpx=function(t){return t?parseInt(t.substring(0,t.length-2),10):0},C.Util.getRectPointsWithSAndE=function(t,e){var i=e.x,r=t.y,n=t.x,o=e.y;return[{x:t.x,y:t.y},{x:i,y:r},{x:e.x,y:e.y},{x:n,y:o}]},C.Util.pointInPoly=function(t,e){for(var i=!1,r=-1,n=e.length,o=n-1;++r<n;o=r)(e[r].y<=t.y&&t.y<e[o].y||e[o].y<=t.y&&t.y<e[r].y)&&t.x<(e[o].x-e[r].x)*(t.y-e[r].y)/(e[o].y-e[r].y)+e[r].x&&(i=!i);return i},C.Util.preventDefault=function(t){t.preventDefault?t.preventDefault():window.event.returnValue=!1},C.Util.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():window.event.cancelBubble=!0},C.Util.getButton=function(t){if(t=t||window.event,!+[1])switch(t.button){case 0:case 1:case 3:case 5:case 7:return 0;case 2:case 6:return 2;case 4:return 1}return t.button},C.Util.createTextArea=function(t,e,i,r){var n=document.createElement("textarea");return n.id=t,n.style.width=e+"px",n.style.height=i+"px",n.style.resize="none",r&&(n.style.position="absolute"),n.style.zIndex=1,n},C.Util.colorRgb=function(t,e){return"rgba("+parseInt("0x"+t.slice(1,3))+","+parseInt("0x"+t.slice(3,5))+","+parseInt("0x"+t.slice(5,7))+","+e+")"},C.Util.getIEVersion=function(){var t=window.navigator.userAgent.toLowerCase();return/msie 8\.0/i.test(t)?8:/msie 7\.0/i.test(t)?7:/msie 6\.0/i.test(t)?6:0},C.Util.formatGeoPointsWithDlt=function(t,e,i,r){for(var n=e.length,o=t.getZoom()/t.getSize().w,s=i*o,a=r*o,l=[],h=0;h<n;h++){var u=e[h];l.push({x:u.x+s,y:u.y-a})}return l},C.Util.formatGeoPointsWithDeleteIndex=function(t,e){for(var i=t.length,r=[],n=0;n<i;n++){var o=t[n];(n!==e||i<=3)&&r.push({x:o.x,y:o.y})}return r},C.Util.calRectNewPointsWithNodesIndexTmpPoint=function(t,e,i,r,n){for(var o=e.length,s=t.getZoom()/t.getSize().w,a=r*s,l=n*s,h=[],u=[],c=0;c<o;c++){var y=e[c],f=C.Util.worldToScreen(t,y.x,y.y);i.includes(c)?(h.push({x:y.x+a,y:y.y-l}),u.push({x:f.x+r,y:f.y+n})):(h.push({x:y.x,y:y.y}),u.push({x:f.x,y:f.y}))}return{points:h,sPoints:u}},C.Util.calPolygonNewPointsWithNodesIndexTmpPoint=function(t,e,i,r){for(var n=e.length,o=[],s=[],a=0;a<n;a++){var l=e[a],h=C.Util.worldToScreen(t,l.x,l.y);if(o.push({x:l.x,y:l.y}),s.push({x:h.x,y:h.y}),a===i){o.push({x:r.x,y:r.y});var u=C.Util.worldToScreen(t,r.x,r.y);s.push({x:u.x,y:u.y})}}return{points:o,sPoints:s}},C.Util.calRectNewPointsWithNodesIndexFormalPoint=function(t,e,i,r,n,o,s){for(var a=e.length,l=t.getZoom()/t.getSize().w,h=n*l,u=o*l,c=[],y=[],f=0;f<a;f++){var d=e[f],p=C.Util.worldToScreen(t,d.x,d.y),v=i.indexOf(f);"y"===s&&0===v||"x"===s&&1===v?(c.push({x:d.x,y:d.y-u}),y.push({x:p.x,y:p.y+o})):"y"===s&&1===v||"x"===s&&0===v?(c.push({x:d.x+h,y:d.y}),y.push({x:p.x+n,y:p.y})):f===r?(c.push({x:d.x+h,y:d.y-u}),y.push({x:p.x+n,y:p.y+o})):(c.push({x:d.x,y:d.y}),y.push({x:p.x,y:p.y}))}return{points:c,sPoints:y}},C.Util.calPolygonNewPointsWithNodesIndexFormalPoint=function(t,e,i,r,n){for(var o=e.length,s=t.getZoom()/t.getSize().w,a=r*s,l=n*s,h=[],u=[],c=0;c<o;c++){var y=e[c],f=C.Util.worldToScreen(t,y.x,y.y);c===i?(h.push({x:y.x+a,y:y.y-l}),u.push({x:f.x+r,y:f.y+n})):(h.push({x:y.x,y:y.y}),u.push({x:f.x,y:f.y}))}return{points:h,sPoints:u}},C.Util.getBounds=function(t){if(!t.length)return[];for(var e=t[0].x,i=t[0].y,r=t[0].x,n=t[0].y,o=1;o<t.length;o++)e>t[o].x&&(e=t[o].x),r<t[o].x&&(r=t[o].x),i>t[o].y&&(i=t[o].y),n<t[o].y&&(n=t[o].y);return[{x:e,y:n},{x:r,y:n},{x:r,y:i},{x:e,y:i}]},C.Util.Key={},C.Util.Key.EVENT="on",C.Util.Key.FLAG={},C.Util.Key.EVENTS={},C.Util.Key.addEventListener=function(t,e){var i=t.join("_");C.Util.Key.EVENTS[i]=e},C.Util.Key.removeEventListener=function(t){var e=t.join("_");delete C.Util.Key.EVENTS[e]},document.addEventListener("keydown",function(t){var e=t.keyCode;if(C.Util.Key.FLAG[e]=!0,"off"!==C.Util.Key.EVENT)for(var i in C.Util.Key.EVENTS){var r=i.split("_"),n=C.Util.Key.EVENTS[i],o=!0;r.forEach(function(t){C.Util.Key.FLAG[1*t]||(o=!1)}),o&&n()}}),document.addEventListener("keyup",function(t){var e=t.keyCode;C.Util.Key.FLAG[e]=!1}),C.Util.Key.isActive=function(t){return C.Util.Key.FLAG[t+""]},C.Graph={},C.Graph.drawPoint=function(t,e){var i=C.Util.transformScreenXYWithDpr(e),r=C.Util.getDpr();t.beginPath(),t.arc(i.x,i.y,3*r,0,2*Math.PI,!0),t.closePath(),t.fill()},C.Graph.drawPoints=function(t,e){for(var i=0;i<e.length;i++){var r={x:e[i].x,y:e[i].y};this.drawPoint(t,r)}},C.Graph.drawLine=function(t,e,i){t.beginPath();var r=C.Util.transformScreenXYWithDpr(e),n=C.Util.transformScreenXYWithDpr(i);t.moveTo(r.x,r.y),t.lineTo(n.x,n.y),t.closePath(),t.stroke()},C.Graph.drawRect=function(t,e,i,r){var n=C.Util.getDpr(),o=C.Util.transformScreenXYWithDpr(e);t.strokeRect(o.x,o.y,i*n,r*n)},C.Graph.drawGeoRect=function(t,e,i,r,n){var o=C.Util.getDpr(),s=C.Util.worldToScreen(t,i.x,i.y),a=C.Util.worldToScreenDistance(t,r,n),l=C.Util.transformScreenXYWithDpr(s);e.strokeRect(l.x,l.y,a.w*o,a.h*o)},C.Graph.drawPolygon=function(t,e){var i=e.length;if(2<=i){t.beginPath();var r=C.Util.transformScreenXYWithDpr(e[0]);t.moveTo(r.x,r.y);for(var n=1;n<i;n++)r=C.Util.transformScreenXYWithDpr(e[n]),t.lineTo(r.x,r.y);t.closePath()}t.stroke()},C.Graph.drawGeoPoint=function(t,e,i){var r=C.Util.worldToScreen(t,i.x,i.y),n=C.Util.transformScreenXYWithDpr(r),o=C.Util.getDpr();e.beginPath(),e.arc(n.x,n.y,3*o,0,2*Math.PI,!0),e.closePath(),e.fill()},C.Graph.drawGeoLineWith=function(t,e,i,r){var n=C.Util.worldToScreen(t,i.x,i.y),o=C.Util.worldToScreen(t,r.x,r.y),s=C.Util.transformScreenXYWithDpr(n),a=C.Util.transformScreenXYWithDpr(o);e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(a.x,a.y),e.closePath(),e.stroke()},C.Graph.drawGeoPoints=function(t,e,i){for(var r=0;r<i.length;r++){var n=C.Util.worldToScreen(t,i[r].x,i[r].y);this.drawPoint(e,n)}},C.Graph.drawGeoPolygon=function(t,e,i){var r=i.length;if(2<=r){e.beginPath();var n=C.Util.worldToScreen(t,i[0].x,i[0].y),o=C.Util.transformScreenXYWithDpr(n);e.moveTo(o.x,o.y);for(var s=1;s<r;s++){var a=C.Util.worldToScreen(t,i[s].x,i[s].y),l=C.Util.transformScreenXYWithDpr(a);e.lineTo(l.x,l.y)}e.closePath()}e.stroke()},C.Graph.drawDashGeoPolygon=function(t,e,i){var r=i.length;if(2<=r){e.beginPath();var n=C.Util.worldToScreen(t,i[0].x,i[0].y),o=C.Util.transformScreenXYWithDpr(n);e.moveTo(o.x,o.y);for(var s=1;s<r;s++){var a=C.Util.worldToScreen(t,i[s].x,i[s].y),l=C.Util.transformScreenXYWithDpr(a);if(e.lineTo(l.x,l.y),s===r-1){if(e.stroke(),r<=2)return;var h=e.globalAlpha;e.setLineDash([10,20]),e.globalAlpha=.3,e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(o.x,o.y),e.stroke(),e.setLineDash([]),e.globalAlpha=h}}}},C.Graph.drawText=function(t,e,i,r){var n=C.Util.transformScreenXYWithDpr({x:i,y:r});e.fillText(t,n.x,n.y)},C.Graph.drawGeoText=function(t,e,i,r,n){var o=C.Util.worldToScreen(t,r,n),s=C.Util.transformScreenXYWithDpr(o);i.fillText(e,s.x,s.y)},C.Geometry=o.extend({init:function(t){this.name=t},getVertices:function(){},getBounds:function(){},calcBounds:function(){}}),C.Geometry.Point=o.extend({init:function(t,e){this.x=t,this.y=e,this.className="point"}}),C.Geometry.LineString=C.Geometry.extend({init:function(t){this.className="line",this.points=[];for(var e=0;e<t.length;e++){var i=t[e];i instanceof C.Geometry.Point?this.points.push(i):alert("初始化节点失败！")}},addPoint:function(t,e){/^\d+$/.test(e)?this.points.splice(e,0,t):this.points.push(t)},delPoint:function(t){this.points.splice(t,1)},removePoint:function(t){for(var e=0;e<this.points.length;e++)if(this.points[e]===t){this.points.splice(e,1);break}},getLength:function(){for(var t=this.points.length,e=0,i=0;i<t-1;i++){e+=Math.sqrt((this.points[i].x-this.points[i+1].x)*(this.points[i].x-this.points[i+1].x)+(this.points[i].y-this.points[i+1].y)*(this.points[i].y-this.points[i+1].y))}return e}}),C.Geometry.LinearRing=C.Geometry.LineString.extend({init:function(t){if(t.length<=2)alert("组成多边形节点个数不足！");else{this._super(t),this.className="polygon";var e=t[0];this.points.push(e)}},addPoint:function(t,e){this.points.splice(e,0,t)},delPoint:function(t){if(4!==this.points.length){if(this.points.splice(t,1),0===t){this.points.pop();var e=this.points[0];this.points.push(e)}}else alert("节点数低于3个，不能删除！")},getCenterPoint:function(){for(var t=this.points,e=t.length,i=0,r=0,n=0;n<e;n++)i+=t[n].x,r+=t[n].y;var o=i/e,s=r/e;return new C.Geometry.Point(o,s)},getArea:function(){for(var t=0,e=this.points,i=0;i<e.length;i++)t+=e[i].x*e[(i+1)%e.length].y-e[(i+1)%e.length].x*e[i].y;return parseInt(Math.abs(.5*t),10)}}),C.Geometry.RectRing=C.Geometry.LineString.extend({init:function(t){t.length<4?alert("组成矩形节点个数不足！"):(this._super(t),this.className="rect")},addPoint:function(t,e){this.points.splice(e,0,t)},delPoint:function(t){if(4!==this.points.length){if(this.points.splice(t,1),0===t){this.points.pop();var e=this.points[0];this.points.push(e)}}else alert("节点数低于3个，不能删除！")},getArea:function(){for(var t=0,e=this.points,i=0;i<e.length;i++)t+=e[i].x*e[(i+1)%e.length].y-e[(i+1)%e.length].x*e[i].y;return parseInt(Math.abs(.5*t),10)}}),C.Geometry.RadiusRing=C.Geometry.extend({init:function(t,e){this.radius=e,this.centerPoint=t,this.className="radius"},getArea:function(){return 6.28318*this.radius*this.radius}}),C.Feature=o.extend({init:function(t,e,i,r){this.activeSatus=!1,this.hoverStatus=!1,this.visible=!1,this.id=t,this.points=e,this.data=i||{},this.gStyle=r},onAdd:function(t){this._layerID=t.id,this._layer=t,this.visible=!0,this.setEditVertices(),this.style=this.gStyle||t.featureStyle||new C.Style({}),this.hoveStyle=t.featureHoverStyle||new C.Style({strokeColor:"#FF0000",lineWeight:1}),this.activeStyle=t.featureActiveStyle||new C.Style({strokeColor:"#FF0000",lineWeight:1}),this.onDraw(t)},onRemove:function(t){},getVertices:function(){return this.points},setEditVertices:function(){for(var t=this.points,e=t.length,i=this._layer.getMap(),r=[],n=0;n<e-1;n++){var o=t[n],s=t[n+1],a=-1<n-1?n-1:e-1,l=(t[a].y-s.y)/(t[a].x-s.x);r.push({point:o,sPoint:C.Util.worldToScreen(i,o.x,o.y),type:"formal",index:n,k:-1/l,relationNodesIndex:[a,n+1]});var h={x:(o.x+s.x)/2,y:(o.y+s.y)/2},u=(s.y-o.y)/(s.x-o.x);if(r.push({point:h,sPoint:C.Util.worldToScreen(i,h.x,h.y),type:"tmp",index:n,k:-1/u,relationNodesIndex:[n,n+1]}),n===e-2){var c=(t[0].y-o.y)/(t[0].x-o.x);r.push({point:s,sPoint:C.Util.worldToScreen(i,s.x,s.y),type:"formal",index:n+1,k:-1/c,relationNodesIndex:[n,0]});var y=t[0],f={x:(y.x+s.x)/2,y:(y.y+s.y)/2},d=(t[0].y-s.y)/(t[0].x-s.x);r.push({point:f,sPoint:C.Util.worldToScreen(i,f.x,f.y),type:"tmp",index:n,k:-1/d,relationNodesIndex:[n+1,0]})}}this._editPoints=r},catchPointWithPos:function(t){if(!this.visible)return{flag:!1,point:null};for(var e=this._editPoints,i=this._layer.getMap(),r=C.Util.worldToScreen(i,t.x,t.y),n=e.length,o=0;o<n;o++){var s=e[o].sPoint,a=(r.x-s.x)*(r.x-s.x)+(r.y-s.y)*(r.y-s.y);if(Math.sqrt(a)<=10)return{flag:!0,point:e[o]}}return{flag:!1,point:null}},show:function(){this.visible||(this.visible=!0,this._layer.renew())},hide:function(){this.visible&&(this.visible=!1,this._layer.renew())},update:function(t){this.points=t.points||this.points,this.data=t.data||this.data,this.style=t.style||this.style,t.points&&this.setEditVertices(),this._layer.renew()},pointInFeature:function(t){return!(!C.Util.pointInPoly(t,this.points)||!this.visible)},hover:function(t){this.hoverStatus||(this.hoveStyle=t||this.hoveStyle,this.hoverStatus=!0,this._layer.renew())},deHover:function(){this.hoverStatus&&(this.hoverStatus=!1,this._layer.renew())},active:function(t){this.activeSatus||(this.activeStyle=t||this.activeStyle,this.activeSatus=!0,this._layer.renew())},deActive:function(){this.activeSatus&&(this.activeSatus=!1,this._layer.renew())},getStyle:function(){return this.activeSatus||this.hoverStatus,this.style},onDraw:function(t){if(this.visible){var e=t.getCtx(),i=this.getStyle(),r=C.Util.getDpr();C.Util.setStyle(e,i),this.hoverStatus&&!this.activeSatus&&(e.lineWidth=2*i.lineWeight*r),i.lineDash?e.setLineDash([10,5]):e.setLineDash([]);var n=t.getMap();e.globalAlpha=1,this.activeSatus&&(e.strokeStyle="#FF0000");var o=this.points.length;if(2<=o){e.beginPath();var s=C.Util.worldToScreen(t._map,this.points[0].x,this.points[0].y),a=C.Util.transformScreenXYWithDpr(s);e.moveTo(a.x,a.y);for(var l=1;l<o;l++)s=C.Util.worldToScreen(t._map,this.points[l].x,this.points[l].y),a=C.Util.transformScreenXYWithDpr(s),e.lineTo(a.x,a.y);e.closePath()}if(e.stroke(),t._opacity?e.globalAlpha=0:e.globalAlpha=this.style.opacity,e.fill(),this.activeSatus){var h=this._editPoints.filter(function(t){return"formal"===t.type}),u=this._editPoints.filter(function(t){return"tmp"===t.type});e.globalAlpha=1,e.fillStyle="#FF0000",C.Graph.drawGeoPoints(n,e,h.map(function(t){return t.point})),e.globalAlpha=1,e.fillStyle="#FF9900",C.Graph.drawGeoPoints(n,e,u.map(function(t){return t.point}))}}},getBounds:function(){for(var t=this.getVertices(),e=t[0].x,i=t[0].y,r=t[0].x,n=t[0].y,o=1;o<t.length;o++)e>t[o].x&&(e=t[o].x),r<t[o].x&&(r=t[o].x),i>t[o].y&&(i=t[o].y),n<t[o].y&&(n=t[o].y);return[{x:e,y:n},{x:r,y:n},{x:r,y:i},{x:e,y:i}]},calcBounds:function(){}}),C.Feature.Rect=C.Feature.extend({init:function(t,e,i,r){this._super(t,e,i,r),this.type="rect"}}),C.Feature.Polygon=C.Feature.extend({init:function(t,e,i,r){this._super(t,e,i,r),this.type="polygon"}}),C.Marker=o.extend({init:function(t,e){this.id=t,this._img=new Image,this._img.src=e.src,this.src=e.src,this._img.style.position="absolute",this._img.style.zIndex=100,this.info=e},onAdd:function(t){var e=(this._layer=t).getMap(),i=this._container=t.getLayerContainer();this.x=this.info.x,this.y=this.info.y;var r=C.Util.worldToScreen(e,this.info.x,this.info.y);this._img.style.left=r.x+this.info.offset.x+"px",this._img.style.top=r.y+this.info.offset.y+"px",this._img.style.cursor="pointer",i.appendChild(this._img)},onRemove:function(){this._container.removeChild(this._img)},update:function(t){t.src&&(this._img.src=t.src),t.x&&(this.info.x=t.x),t.y&&(this.info.y=t.y),t.offset&&(this.info.offset=t.offset),this.renew()},regEvent:function(t,e){if("click"===t){var i=this;C.Util.addEvtHandler(this._img,"mousedown",function(t){C.Util.preventDefault(t),C.Util.stopPropagation(t)}),C.Util.addEvtHandler(this._img,"mouseup",function(t){0===C.Util.getButton(t)&&e.apply(i,arguments),C.Util.preventDefault(t),C.Util.stopPropagation(t)}),C.Util.addEvtHandler(this._img,"click",function(t){C.Util.preventDefault(t),C.Util.stopPropagation(t)})}},renew:function(){var t=this._layer.getMap(),e=C.Util.worldToScreen(t,this.info.x,this.info.y);this._img.style.left=e.x+this.info.offset.x+"px",this._img.style.top=e.y+this.info.offset.y+"px"},showInfo:function(){console.log("Hello ...")}}),C.Text=o.extend({init:function(t,e,i){this.id=t,this.startPoint=e.pos,this.offset=e.offset||{x:0,y:0},this.boxMaxWidth=e.width,this.wrap=e.wrap||!1,this.text=e.text,this.style=i||new C.Style({})},onAdd:function(t){var e=this.id;this._w=this.boxMaxWidth;var i=C.Util.createDiv(e,this._w,this._h,!0);i.style.borderWidth=0,i.style.width="auto",i.style.maxWidth=this._w+"px",this.wrap||(i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.style.whiteSpace="nowrap"),this._textContainer=i,(this._container=t.getLayerContainer()).appendChild(this._textContainer),this._layer=t,this.onDraw(t)},update:function(t){t.pos&&(this.startPoint=t.pos),t.offset&&(this.offset=t.offset),t.text&&(this.text=t.text),t.width&&(this.boxMaxWidth=t.width),t.style&&(this.style=t.style),this.renew()},onDraw:function(t){var e=C.Util.worldToScreen(t._map,this.startPoint.x,this.startPoint.y);e.x=e.x+this.offset.x,e.y=e.y+this.offset.y,this._textContainer.style.fontSize=this.style.fontSize+"px",this._textContainer.style.lineHeight=this.style.fontSize+"px",this._textContainer.style.fontFamily=this.style.fontFamily+",SimSun",this._textContainer.style.color=this.style.fontColor,this._textContainer.style.borderRadius="1px",this._textContainer.style.boxSizing="border-box",this._textContainer.style.padding="1px";var i=this.style.opacity||0===this.style.opacity?this.style.opacity:1,r=C.Util.colorRgb(this.style.bgColor,i);this._textContainer.style.background=r,this._textContainer.textContent=this.text,this._textContainer.style.left=e.x+"px",this._textContainer.style.top=e.y+"px",t._layerContainer.appendChild(this._textContainer)},setText:function(t){this.text=t,this.refresh()},setPosition:function(t,e){this.startPoint.x=t,this.startPoint.y=e},setSize:function(t){this._w=this.boxMaxWidth=t},onRemove:function(){this._container.removeChild(this._textContainer)},getContainer:function(){return this._textContainer},renew:function(){var t=this._layer;this.onDraw(t)},refresh:function(){this.renew()}}),C.Style=o.extend({init:function(t){this.oStyle="singleStyle",this.fillColor=t.fillColor?t.fillColor:"#00DD00",this.strokeColor=t.strokeColor?t.strokeColor:"#00DD00",this.lineWeight=t.lineWeight?t.lineWeight:1,this.borderStatus=!t.borderStatus||t.borderStatus,this.cirRadius=t.cirRadius?t.cirRadius:3,this.fillStatus=!t.fillStatus||t.fillStatus,this.vtxStatus=!!t.vtxStatus&&t.vtxStatus,this.vtxRadius=t.vtxRadius?t.vtxRadius:3,this.tlr=t.tlr?t.tlr:5,this.opacity=t.opacity||0===t.opacity?t.opacity:1,this.mappingValue=t.mappingValue?t.mappingValue:"default",this.fontSize=t.fontSize?t.fontSize:13,this.fontFamily=t.fontFamily?t.fontFamily:"KaiTi",this.fontColor=t.fontColor?t.fontColor:"#333333",this.bgColor=t.bgColor?t.bgColor:"#ffffff",this.lineDash=t.lineDash||!1}}),C.StyleEx=o.extend({init:function(t,e){this.oStyle="multiStyles",this.styles=t,this.mappingField=e}}),C.Edit={},C.Edit.mouseDown=function(t,e){var i=C.Util.getMouseXY(t._container,e),r=C.Util.screenToWorld(t,i.x,i.y),n=t.mode;switch(n){case"drawRect":case"drawPolygon":if(t.activeFeature){var o=t.activeFeature.type;if("rect"===o)t.dragging=!0;else if("polygon"===o){var s=C.Util.getButton(e),a=t.activePoint;if(a&&"formal"===a.type&&2===s){var l=t.activeFeature.points,h=C.Util.formatGeoPointsWithDeleteIndex(l,t.activePoint.index);t.userGeometryEditDone&&t.userGeometryEditDone("polygon",t.activeFeature,h)}else t.dragging=!0}}else{t.resetLayerStatus("active");var u=new C.Geometry.Point(r.x,r.y);"drawRect"===n?t.drawGeometryPoints.push(u):"drawPolygon"===n&&(t.tipLayer.setGeoText("ctrl+z撤销",r.x,r.y),t.drawGeometryPoints.push(u))}}},C.Edit.mouseMove=function(t,e){var i=t.overLayer.getCtx(),r=e.srcElement?C.Util.getMouseXY(t._container,e):e,n=C.Util.screenToWorld(t,r.x,r.y),o=r.x-t.startX,s=r.y-t.startY,a=t.mode,l=t.drawGeometryPoints,h=l.length;switch(a){case"drawRect":case"drawPolygon":t.overLayer.clear(),t.tipLayer.clear(),t.globalStyle?C.Util.setStyle(i,t.globalStyle):t.overLayer.setInitStyle();var u=t.activeFeature,c=t.hoverFeature;if(u){var y=t.activePoint,f=u.points,d=u.type;if(t.dragging)if(t.overLayer.setEditStyle(),t.overLayer.topzIndex(),u.visible&&u.hide(),y){var p=[],v=t.activePoint,x=v.type,g=v.relationNodesIndex,m=v.index;if("tmp"===x)if("rect"===d){var w=I(t,o,s);p=C.Util.calRectNewPointsWithNodesIndexTmpPoint(t,f,g,w.dltx,w.dlty)}else"polygon"===d&&(p=C.Util.calPolygonNewPointsWithNodesIndexTmpPoint(t,f,g[0],n));else if("formal"===x)if("rect"===d){var S=F(t);p=C.Util.calRectNewPointsWithNodesIndexFormalPoint(t,f,g,m,o,s,S.flag)}else"polygon"===d&&(p=C.Util.calPolygonNewPointsWithNodesIndexFormalPoint(t,f,m,o,s));C.Graph.drawPolygon(i,p.sPoints),t.userGeometryEditing&&t.userGeometryEditing(d,u,p.points)}else{var P=C.Util.formatGeoPointsWithDlt(t,f,o,s);C.Graph.drawGeoPolygon(t,i,P),t.userGeometryEditing&&t.userGeometryEditing(d,u,P)}else y&&"formal"===y.type&&3<f.length&&"polygon"===d&&t.tipLayer.setGeoText("右键删除节点",n.x,n.y)}else if(0<h)if(t.overLayer.topzIndex(),"drawRect"===a){var _=[l[0],{x:n.x,y:l[0].y},n,{x:l[0].x,y:n.y}];C.Graph.drawGeoPolygon(t,i,_)}else{1<h&&t.tipLayer.setGeoText("双击结束绘制",n.x,n.y);var U=[].concat(T(l),[n]);C.Graph.drawDashGeoPolygon(t,i,U)}else c&&t.tipLayer.setGeoText("双击选择编辑",n.x,n.y)}return!0},C.Edit.mouseUp=function(t,e){var i=C.Util.getMouseXY(t._container,e),r=C.Util.screenToWorld(t,i.x,i.y),n=i.x-t.startX,o=i.y-t.startY,s=t.mode;switch(s){case"drawRect":case"drawPolygon":var a=t.activeFeature,l=t.activePoint,h=t.dragging;if(a){var u=a.points,c=a.type,y="drawRect"===s?"rect":"polygon";if(h){t.overLayer.clear();var f=[];if(l){var d=l.type,p=l.relationNodesIndex,v=l.index,x=[];if("tmp"===d)if("rect"===c){var g=I(t,n,o);x=C.Util.calRectNewPointsWithNodesIndexTmpPoint(t,u,p,g.dltx,g.dlty)}else"polygon"===c&&(x=C.Util.calPolygonNewPointsWithNodesIndexTmpPoint(t,u,p[0],r));else if("formal"===d)if("rect"===c){var m=F(t);x=C.Util.calRectNewPointsWithNodesIndexFormalPoint(t,u,p,v,n,o,m.flag)}else"polygon"===c&&(x=C.Util.calPolygonNewPointsWithNodesIndexFormalPoint(t,u,v,n,o));f=x.points}else f=C.Util.formatGeoPointsWithDlt(t,u,n,o);t.userGeometryEditDone&&t.userGeometryEditDone(y,t.activeFeature,f),t.dragging=!1}}else if(0<t.drawGeometryPoints.length&&"drawRect"===s){t.overLayer.clear();var w=t.drawGeometryPoints[0],S=new C.Geometry.Point(r.x,r.y),P=C.Util.getRectPointsWithSAndE(w,S);Math.abs(P[0].x-P[2].x)<2||Math.abs(P[0].y-P[2].y)<2?(t.drawGeometryPoints=[],console.log("invalid points data: 绘制矩形 —— 不是有效矩形框...")):t.drawGeometryPoints=P}}},C.Edit.mouseDblClick=function(t,e){switch(t.mode){case"drawRect":t.tipLayer.clear();break;case"drawPolygon":t.overLayer.clear(),t.tipLayer.clear(),t.drawGeometryPoints.pop(),3<=t.drawGeometryPoints.length||(t.drawGeometryPoints=[],console.log("invalid points data: 绘制多边形 —— 不是有效多边形..."))}},C.Map=o.extend({init:function(t,e){this._options=e||{},this.privateInitContainer(t),this.privateInitProp(),this.privateInitEvent(),this.overLayer=new C.Layer.Overlay("overlay"),this.tipLayer=new C.Layer.Tip("tip"),this.mLayer=new C.Layer.Marker("markerLayer"),this.addLayer(this.overLayer),this.addLayer(this.tipLayer),this.addLayer(this.mLayer),this.attachEvents(),this.registerShortKeyEvent()},attachEvents:function(){var e=this;e.events={on:function(t,r){switch(t){case"mouseDown":e.userMouseDown=function(t){var e=r(t);return"boolean"!=typeof e||e};break;case"mouseMove":e.userMouseMove=function(t){r(t)};break;case"geometryEditing":e.userGeometryEditing=function(t,e,i){r(t,e,i)};break;case"geometryEditDone":e.userGeometryEditDone=function(t,e,i){r(t,e,i)};break;case"geometryDrawDone":e.userGeometryDrawDone=function(t,e){r(t,e)};break;case"featureHover":e.userFetureHover=function(t){r(t)};break;case"featureSelected":e.userFetureSelected=function(t){r(t)};break;case"featureStatusReset":e.userFeatureStatusReset=function(t){r(t)}}}}},registerShortKeyEvent:function(){var t=this;C.Util.Key.addEventListener([17,90],function(){"drawPolygon"===t.mode&&t.drawGeometryPoints.length&&(t.drawGeometryPoints.pop(),C.Edit.mouseMove(t,{x:t.middleX,y:t.middleY}))})},privateInitContainer:function(t){this._container=document.getElementById(t),this._container.innerHTML="",this.w=this._options.w||this._container.clientWidth,this.h=this._options.h||this._container.clientHeight,this._container.style.overflow="hidden",this._container.style.userSelect="none",this._container.oncontextmenu=function(){return!1}},getContainer:function(){return this._container},getSize:function(){return{w:this.w,h:this.h}},privateInitProp:function(){this.mode="pan",this.dragging=!1,this.autoPanTimer=null,this.oLayers=[],this.zoom=this._options.zoom||parseInt(1*this.w,10),this.cx=this._options.cx||0,this.cy=this._options.cy||0,this.startX=0,this.startY=0,this.startScrX=0,this.startSrcY=0,this.middleX=0,this.middleY=0,this.zoomScale=.025,this.zoomMax=this._options.zoomMax||1e9,this.zoomMin=this._options.zoomMin||0,this.drawGeometryPoints=[],this.activeFeature=null,this.activePoint=null},privateInitEvent:function(){var d=this,t=this._container;C.Util.addEvtHandler(t,"mousedown",function(t){var e=t||window.event;window.event||e.preventDefault();var i=C.Util.getMouseXY(d._container,e),r=C.Util.screenToWorld(d,i.x,i.y),n=C.Util.getMousePos(e);d.startX=i.x,d.startY=i.y,d.startScrX=n.x,d.startScrY=n.y,"pan"===d.mode?(d.resetLayerStatus("active"),function(t){d.dragging=!0;for(var e=d.getAllLayers(),i=0;i<e.length;i++)e[i].startLeft=C.Util.delpx(e[i]._layerContainer.style.left),e[i].startTop=C.Util.delpx(e[i]._layerContainer.style.top)}(),document.onmousemove=function(t){!function(t){var e=C.Util.getMousePos(t);if(d.dragging){var i=e.x-d.startScrX,r=e.y-d.startScrY,n=d.getAllLayers();if(0<Math.abs(i)||0<Math.abs(r))for(var o=0;o<n.length;o++)n[o].onDrag(i,r)}}(t)},document.onmouseup=function(t){document.onmousemove=null,document.onmouseup=null,function(t){var e=C.Util.getMousePos(t),i=e.x-d.startScrX,r=e.y-d.startScrY;if(0<Math.abs(i)||0<Math.abs(r)){var n=d.getScreenCenter(),o=n.x-i,s=n.y-r,a=C.Util.screenToWorld(d,o,s);d.setCenter(a.x,a.y);for(var l=d.getAllLayers(),h=0,u=l.length;h<u;h++)l[h].renew()}d.dragging=!1}(t)}):(o=e,C.Edit.mouseDown(d,o));var o;d.userMouseDown&&d.userMouseDown(r)}),C.Util.addEvtHandler(t,"mousemove",function(t){var e=C.Util.getMouseXY(d._container,t),i=C.Util.screenToWorld(d,e.x,e.y);d.middleX=e.x,d.middleY=e.y,("drawPolygon"===d.mode||"drawRect"===d.mode)&&(d.dragging||0<d.drawGeometryPoints.length)&&(e.x<=10||e.y<=10||e.x>=d.w-10||e.y>=d.h-10)?!d.autoPanTimer&&(d.autoPanTimer=window.setInterval(function(){return function(t){var e=t.left,i=t.right,r=t.top,n=t.bottom,o=d.getScreenCenter(),s=e?-.2:i?.2:0,a=r?-.2:n?.2:0,l=o.x+s,h=o.y+a,u=C.Util.screenToWorld(d,l,h);d.setCenter(u.x,u.y);for(var c=d.getAllLayers(),y=0,f=c.length;y<f;y++)c[y].renew()}({left:e.x<=10,right:e.x>=d.w-10,top:e.y<=10,bottom:e.y>=d.h-10})},0)):d.autoPanTimer&&(window.clearInterval(d.autoPanTimer),d.autoPanTimer=null);!d.dragging&&d.handleDrawEditGeometryMouseMove(i),C.Edit.mouseMove(d,t),d.userMouseMove&&d.userMouseMove(i),!d.dragging&&d.setTargets(i,"hover")}),C.Util.addEvtHandler(t,"mouseup",function(t){var e=C.Util.getMouseXY(d._container,t);C.Util.screenToWorld(d,e.x,e.y);if(C.Edit.mouseUp(d,t),d.drawGeometryPoints.length)switch(d.mode){case"drawRect":d.userGeometryDrawDone&&d.userGeometryDrawDone("rect",d.drawGeometryPoints),d.drawGeometryPoints=[]}else d.overLayer.resetzIndex(),d.mode}),C.Util.addEvtHandler(t,"mousewheel",function(t){C.Util.preventDefault(t);var e=C.Util.getMouseXY(d._container,t),i=C.Util.screenToWorld(d,e.x,e.y);if("pan"===d.mode||"drawPolygon"===d.mode||"drawRect"===d.mode){var r=t.wheelDelta||-t.detail;if(0<r){if(d.zoom<=this.zoomMin)return;var n=(i.x-d.cx)*(1-d.zoomScale),o=(i.y-d.cy)*(1-d.zoomScale),s=i.x-n,a=i.y-o;d.setCenter(s,a),d.zoomIn(1)}else{if(d.zoom>=this.zoomMax)return;var l=(i.x-d.cx)/(1-d.zoomScale),h=(i.y-d.cy)/(1-d.zoomScale),u=i.x-l,c=i.y-h;d.setCenter(u,c),d.zoomOut(1)}"drawPolygon"!==d.mode&&"drawRect"!==d.mode||!d.drawGeometryPoints.length||C.Edit.mouseMove(d,{x:e.x,y:e.y})}}),C.Util.addEvtHandler(t,"dblclick",function(t){var e=C.Util.getMouseXY(d._container,t),i=C.Util.screenToWorld(d,e.x,e.y);if(C.Edit.mouseDblClick(d,t),d.drawGeometryPoints.length)switch(d.mode){case"drawRect":break;case"drawPolygon":d.userGeometryDrawDone&&d.userGeometryDrawDone("polygon",d.drawGeometryPoints),d.drawGeometryPoints=[]}else switch(d.mode){case"drawRect":case"drawPolygon":!d.activeFeature&&d.setTargets(i,"selected")}})},handleDrawEditGeometryMouseMove:function(o){var s=this;switch(s.mode){case"pan":s.setCursor("pointer");break;case"drawRect":case"drawPolygon":if(function(){for(var t=s.getAllLayers(),e=0;e<t.length;e++)if("featureLayer"===t[e].oClass){var i=t[e].catchFeaturePointWithPos(o,"active");if(i.length)return s.activeFeature=i[0].feature,s.activePoint=i[0].point,!(s.hoverFeature=null);var r=t[e].getFeaturesWithPos(o,"active");if(r.length)return s.activeFeature=r[0],s.activePoint=null,!(s.hoverFeature=null);var n=t[e].getFeaturesWithPos(o,"hover");if(n.length)return s.activeFeature=null,s.activePoint=null,s.hoverFeature=n[0],!1}return s.activeFeature=null,s.activePoint=null,s.hoverFeature=null,!1}()){var t=s.activeFeature;if(s.activePoint&&"rect"===t.type){var e=s.activePoint.k;0<e&&e!==1/0?s.setCursor("nesw-resize"):0===e?s.setCursor("ew-resize"):e<0&&e!==-1/0?s.setCursor("nwse-resize"):s.setCursor("ns-resize")}else s.activePoint&&"polygon"===t.type?s.setCursor("no-drop"):s.setCursor("move")}else s.setCursor("crosshair")}},setTargets:function(t,e){for(var i=this.getAllLayers(),r=[],n=0;n<i.length;n++)r=r.concat(i[n].getFeaturesWithPos(t));if("selected"===e){if(!r.length)return void this.resetLayerStatus("active");r[0].active(),this.handleDrawEditGeometryMouseMove(t),this.userFetureSelected&&this.userFetureSelected(r[0])}else if("hover"===e){if(this.resetLayerStatus("hover"),!r.length)return;r[0].hover(),this.userFetureHover&&this.userFetureHover(r[0])}return this},resetLayerStatus:function(t){for(var e=this.getAllLayers(),i=!1,r=0;r<e.length;r++)"featureLayer"===e[r].oClass&&e[r].resetFeatureStatus(t)&&(i=!0);return t&&"active"===t&&i&&this.userFeatureStatusReset&&this.userFeatureStatusReset(),i},addLayer:function(t){var e=this.oLayers;C.Util.isObjInArray(e,t)||(t.onAdd(this),e.push(t))},removeLayer:function(t){for(var e=[],i=this.oLayers,r=0,n=0;r<i.length;r++)i[r]!==t?(e[n]=i[r],n++):t.onRemove(this);this.oLayers=e},getAllLayers:function(){return this.oLayers},getNewZoom:function(t,e){for(var i=e||6,r=this.zoom;0<i;)"zoomIn"===t?r-=r*this.zoomScale:r/=1-this.zoomScale,i--;return r},getZoom:function(){return this.zoom},setZoom:function(t){this.zoom=t},zoomIn:function(t){if(!(this.zoom<=this.zoomMin)){var e=this.getAllLayers(),i=this.getNewZoom("zoomIn",t);this.zoom=i;for(var r=0;r<e.length;r++)e[r].zoomIn()}},zoomOut:function(t){if(!(this.zoom>=this.zoomMax)){var e=this.getAllLayers(),i=this.getNewZoom("zoomOut",t);this.zoom=i;for(var r=0;r<e.length;r++)e[r].zoomOut()}},setMode:function(t,e){switch(this.mode=t,this.drawGeometryPoints=[],t){case"pan":this.resetLayerStatus()}e&&(this.globalStyle=e)},setCursor:function(t){var e=this._container.style.cursor;e!==t&&(this.previousCursor=e,this._container.style.cursor=t)},resetCursor:function(){this.setCursor(this.previousCursor)},getMode:function(){return this.mode},setCenter:function(t,e){this.cx=t,this.cy=e},centerAndZoom:function(t,e){this.setCenter(t.x,t.y),this.setZoom(e);for(var i=this.getAllLayers(),r=0;r<i.length;r++)i[r].zoomIn()},getCenter:function(){return{x:this.cx,y:this.cy}},getScreenCenter:function(){return{x:this.w/2,y:this.h/2}},resize:function(t,e){var i=this.zoom/this.w,r=t||this._container.clientWidth,n=e||this._container.clientHeight;this.zoom=i*r,this.w=r,this.h=n;for(var o=this.getAllLayers(),s=0;s<o.length;s++)o[s].resize()},destroy:function(){this._container.innerHTML="";var t=this._container;C.Util.removeEvtHandler(t,"mousedown"),C.Util.removeEvtHandler(t,"mousemove"),C.Util.removeEvtHandler(t,"mouseup"),C.Util.removeEvtHandler(t,"mousewheel")}}),C.Layer=o.extend({init:function(t,e){this.id=t,this.visible=!0,this.options=e||{opacity:1,zIndex:0}},onAdd:function(t){this._map=t,this._container=t.getContainer();var e=t.getSize();this.privateInitLayerContainer(this.id,e.w,e.h),this.privateInitProp(t),this.privateInitParams(t),this._container.appendChild(this._layerContainer),this.setzIndex(),this.setOpacity(this.options.opacity)},onRemove:function(t){t.getContainer().removeChild(this._layerContainer)},privateInitProp:function(t){},privateInitParams:function(t){},onDrag:function(t,e){this._layerContainer.style.left=this.startLeft+t+"px",this._layerContainer.style.top=this.startTop+e+"px"},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},renew:function(){this._layerContainer.style.left="0px",this._layerContainer.style.top="0px"},getSize:function(){return{w:this._layerContainer.clientWidth,h:this._layerContainer.clientHeight}},getScreenCenter:function(){return{x:parseInt(this._layerContainer.clientWidth/2,10),y:parseInt(this._layerContainer.clientHeight/2,10)}},getMap:function(){return this._map},getLayerContainer:function(){return this._layerContainer},setzIndex:function(){isNaN(this.options.zIndex)||(this._layerContainer.style.zIndex=this.options.zIndex)},setOpacity:function(t){this.getLayerContainer().style.opacity=t},resize:function(){this._layerContainer.style.width=this._map.w+"px",this._layerContainer.style.height=this._map.h+"px"},getFeaturesWithPos:function(t){return[]},deSelect:function(){}}),C.Layer.Image=C.Layer.extend({init:function(t,e,i,r){this._super(t,r),this._src=e,this._size=i,this.oClass="imgLayer"},privateInitParams:function(t){},privateInitProp:function(t){this._super(),this._mapImg||(this._mapImg=new Image),this._mapImg.style.position="absolute",this._mapImg.src=this._src,this._mapImg.onmousedown=function(t){t.preventDefault()},this._layerContainer.appendChild(this._mapImg),this.renew()},privateInitLayerContainer:function(t,e,i){var r=C.Util.createDiv(t,e,i,!0);r.style.zIndex=2,this._layerContainer=r},onAdd:function(t){this._super(t)},zoomTo:function(){},renew:function(){this._super();var t=this._map.getSize(),e=this._map.zoom/t.w;this._mapImg.width=this._size.w/e;var i=C.Util.worldToScreen(this._map,-1*this._size.w/2,this._size.h/2);this._mapImg.style.left=i.x+"px",this._mapImg.style.top=i.y+"px"},resize:function(){this._super(),this.renew()},refresh:function(){}}),C.Layer.Feature=C.Layer.extend({init:function(t,e){e=e||{},this._super(t,e),this.featureStyle=e.style||new C.Style({}),this.featureHoverStyle=e.hoverStyle||new C.Style({strokeColor:"#FF0000",lineWeight:1}),this.featureActiveStyle=e.activeStyle||new C.Style({strokeColor:"#FF0000",lineWeight:1}),this._opacity=!!e.transparent&&e.transparent,this.oClass="featureLayer"},privateInitLayerContainer:function(t,e,i){var r=C.Util.createCanvas(t,e,i,!0);this._layerContainer=r,this._ctx=r.getContext("2d"),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},privateInitProp:function(t){this._super()},onAdd:function(t){var e=(this._map=t).getSize(),i=this._map.getContainer();this.privateInitLayerContainer(this.id,e.w,e.h),i.appendChild(this._layerContainer),this.setzIndex(),this.oFeatures=[]},addFeature:function(t){var e=this.getAllFeatures();C.Util.isInArray(e,t)||(e.push(t),t.onAdd(this))},getFeatureById:function(t){for(var e=this.getAllFeatures(),i=e.length-1;0<=i;i--)if(e[i].id===t)return e[i];return null},getFeaturesWithPos:function(t,e){for(var i=[],r=this.getAllFeatures(),n=r.length-1;0<=n;n--){var o=r[n],s=!0;e&&"active"===e&&(s=o.activeSatus),e&&"hover"===e&&(s=!0),o.pointInFeature(t)&&s&&i.push(o)}return i},catchFeaturePointWithPos:function(t,e){for(var i=[],r=this.getAllFeatures(),n=r.length-1;0<=n;n--){var o=r[n],s=!0;e&&"active"===e&&(s=o.activeSatus);var a=o.catchPointWithPos(t);a.flag&&s&&i.push({feature:o,point:a.point})}return i},resetFeatureStatus:function(t){for(var e=this.getAllFeatures(),i=!1,r=e.length-1;0<=r;r--){var n=e[r];t&&"active"===t?n.activeSatus&&(i=!(n.activeSatus=!1)):t&&"hover"===t?n.hoverStatus&&(i=!(n.hoverStatus=!1)):(n.activeSatus||n.hoverStatus)&&(n.activeSatus=!1,i=!(n.hoverStatus=!1))}return i&&this.renew(),i},getActiveFeatures:function(){for(var t=[],e=this.getAllFeatures(),i=e.length-1;0<=i;i--)e[i].activeSatus&&t.push(e[i]);return t},getHoverFeatures:function(){for(var t=[],e=this.getAllFeatures(),i=e.length-1;0<=i;i--)e[i].hoverStatus&&t.push(e[i]);return t},removeAllFeatures:function(){this.oFeatures=[],this.renew()},removeFeature:function(t){for(var e=[],i=0,r=0;i<this.oFeatures.length;i++)this.oFeatures[i]!==t?(e[r]=this.oFeatures[i],r++):t.onRemove(this);this.oFeatures=e,this.renew()},removeFeatureById:function(t){for(var e=[],i=0,r=this.oFeatures.length;i<r;i++){var n=this.oFeatures[i];n.id!==t?e.push(n):n.onRemove(this)}this.oFeatures=e,this.renew()},removeFeaturesByIds:function(t){for(var e=[],i=[],r=0,n=this.oFeatures.length;r<n;r++){var o=this.oFeatures[r];t.includes(o.id)?(o.onRemove(this),i.push(o)):e.push(o)}return this.oFeatures=e,this.renew(),i},removeFeaturesByProperty:function(t){for(var e=[],i=[],r=0,n=this.oFeatures.length;r<n;r++){for(var o=this.oFeatures[r],s=!1,a=0,l=t.length;a<l;a++){var h=t[a];if(o.data[h.key]===h.value){s=!0,o.onRemove(this),i.push(o);break}}s||e.push(o)}return this.oFeatures=e,this.renew(),i},draw:function(){for(var t=this.getAllFeatures(),e=0;e<t.length;e++)t[e].onDraw(this)},renew:function(){this._super(),this.clear(),this.draw()},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},clear:function(){var t=this.getLayerContainer();this._ctx.clearRect(0,0,t.width,t.height)},getAllFeatures:function(){return this.oFeatures},getCtx:function(){return this._ctx}}),C.Layer.Overlay=C.Layer.Feature.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:10},this.zIndexTopFlag=!1,this.oClass="overlayLayer"},setStyle:function(t){this.style=t},initStyle:function(){this.setInitStyle(),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},setInitStyle:function(){var t=this.getCtx(),e=C.Util.getDpr();t.strokeStyle="#0000FF",t.fillStyle="#0000FF",t.lineWidth=1*e,t.globalAlpha=.7},setEditStyle:function(){var t=this.getCtx(),e=C.Util.getDpr();t.strokeStyle="#FF0000",t.lineWidth=1*e,t.globalAlpha=.7},onAdd:function(t){this._super(t),this.initStyle()},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},topzIndex:function(){this.zIndexTopFlag||(this._layerContainer.style.zIndex=9999,this.zIndexTopFlag=!0)},resetzIndex:function(){this.zIndexTopFlag&&(this._layerContainer.style.zIndex=this.options.zIndex,this.zIndexTopFlag=!1)}}),C.Layer.Tip=C.Layer.Feature.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:11},this.oClass="tipLayer"},setStyle:function(t){this.style=t},initStyle:function(){this.setInitStyle(),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},setInitStyle:function(){var t=this.getCtx(),e=12*C.Util.getDpr();t.font="".concat(e,"px Arial"),t.textAlign="left",t.textBaseline="bottom",t.fillStyle="#fff",t.globalAlpha=1},onAdd:function(t){this._super(t),this.initStyle()},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},setTextBackground:function(t,e,i,r){var n=this.getCtx();n.beginPath(),n.rect(t,e,i,r),n.fillStyle="#333",n.fill(),n.lineWidth=1,n.strokeStyle="#efefef",n.stroke()},setText:function(t,e,i){if(this.clear(),t){var r=this.getCtx(),n=r.measureText(t).width,o=C.Util.transformScreenXYWithDpr({x:e||0,y:i||0}),s=C.Util.getDpr();this.setTextBackground(o.x+4*s,o.y-16*s,n+7*s,20*s),this.setInitStyle(),r.fillText(t,o.x+7*s,o.y+1*s)}},setGeoText:function(t,e,i){if(this.clear(),t){var r=this.getCtx(),n=r.measureText(t).width,o=C.Util.worldToScreen(this._map,e||0,i||0),s=C.Util.transformScreenXYWithDpr(o),a=C.Util.getDpr();this.setTextBackground(s.x+4*a,s.y-16*a,n+7*a,20*a),this.setInitStyle(),r.fillText(t,s.x+7*a,s.y+1*a)}}}),C.Layer.Marker=C.Layer.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:20},this.id=t,this.oClass="markerLayer",this.oMarkers=[]},privateInitLayerContainer:function(t,e,i){var r=C.Util.createDiv(t,e,i,!0);this._layerContainer=r},addMarker:function(t){C.Util.isInArray(this.oMarkers,t)||(this.oMarkers.push(t),t.onAdd(this))},removeMarker:function(t){for(var e=[],i=0,r=0;i<this.oMarkers.length;i++)this.oMarkers[i]!==t?(e[r]=this.oMarkers[i],r++):this.oMarkers[i].onRemove(this);this.oMarkers=e,this.renew()},removeMarkerById:function(t){for(var e=[],i=0,r=this.oMarkers.length;i<r;i++){var n=this.oMarkers[i];n.id!==t?e.push(n):n.onRemove(this)}this.oMarkers=e,this.renew()},removeMarkersByIds:function(t){for(var e=[],i=[],r=0,n=this.oMarkers.length;r<n;r++){var o=this.oMarkers[r];t.includes(o.id)?(o.onRemove(this),i.push(o)):e.push(o)}return this.oMarkers=e,this.renew(),i},getAllMarkers:function(){return this.oMarkers},getMarkerById:function(t){for(var e=0;e<this.oMarkers.length;e++)if(this.oMarkers[e].id===t)return this.oMarkers[e];return null},addMarkers:function(t){for(var e=0;e<t.length;e++)this.addMarker(t[e])},removeMarkers:function(t){for(var e=t,i=e.length,r=0;r<i;r++){var n=e[r];this.removeMarker(n)}},removeAllMarkers:function(){var t=this.oMarkers;this.removeMarkers(t)},renew:function(){this._super();for(var t=0;t<this.oMarkers.length;t++)this.oMarkers[t].renew()},resize:function(){this._super(),this.renew()}}),C.Layer.Text=C.Layer.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:19},this.id=t,this.oClass="textLayer",this.oTexts=[]},privateInitLayerContainer:function(t,e,i){var r=C.Util.createDiv(t,e,i,!0);this._layerContainer=r},addText:function(t){C.Util.isInArray(this.oTexts,t)||(this.oTexts.push(t),t.onAdd(this))},removeText:function(t){for(var e=[],i=0,r=0;i<this.oTexts.length;i++)this.oTexts[i]!==t?(e[r]=this.oTexts[i],r++):this.oTexts[i].onRemove(this);this.oTexts=e,this.renew()},getTextById:function(t){for(var e=0;e<this.oTexts.length;e++)if(this.oTexts[e].id===t)return this.oTexts[e];return null},removeTextById:function(t){for(var e=[],i=0,r=this.oTexts.length;i<r;i++){var n=this.oTexts[i];n.id!==t?e.push(n):n.onRemove(this)}this.oTexts=e,this.renew()},removeTextsByIds:function(t){for(var e=[],i=[],r=0,n=this.oTexts.length;r<n;r++){var o=this.oTexts[r];t.includes(o.id)?(o.onRemove(this),i.push(o)):e.push(o)}return this.oTexts=e,this.renew(),i},addTexts:function(t){for(var e=0;e<t.length;e++)this.addText(t[e])},removeTexts:function(t){for(var e=t,i=e.length,r=0;r<i;r++){var n=e[r];this.removeText(n)}},getAllTexts:function(){return this.oTexts},removeAllTexts:function(){this._layerContainer.innerHTML="",this.oTexts=[],this.renew()},renew:function(){this._super();for(var t=0;t<this.oTexts.length;t++)this.oTexts[t].renew()},resize:function(){this._super(),this.renew()}}),C});