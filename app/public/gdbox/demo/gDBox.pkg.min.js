!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.gDBox=e()}(this,function(){var r,o=function(){};r=!1,o.extend=function(t){var i=null;function e(){r||(i&&(this._superprototype=i.prototype),this.init.apply(this,arguments))}for(var n in this!==o&&(i=this),i&&(r=!0,(e.prototype=new i).constructor=e,r=!1),e.extend=arguments.callee,t)t.hasOwnProperty(n)&&(e.prototype[n]=i&&"function"==typeof t[n]&&"function"==typeof e.prototype[n]&&/\b_super\b/.test(t[n])?function(t,e){return function(){return this._super=i.prototype[t],e.apply(this,arguments)}}(n,t[n]):t[n]);return e};var P={};function C(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function T(t,e,i){var n=t.activeFeature,r=t.activePoint,o=n.points[r.relationNodesIndex[0]],s=n.points[r.relationNodesIndex[1]],a=Math.sqrt((o.x-s.x)*(o.x-s.x)+(o.y-s.y)*(o.y-s.y)),l=(o.y-s.y)/a,h=(o.x-s.x)/a;return 1===l&&0===h||-1===l&&0===h?{dltx:e,dlty:0}:0===l&&1===h||0===l&&-1===h?{dltx:0,dlty:i}:{dltx:0,dlty:0}}function I(t){var e=t.activeFeature,i=t.activePoint,n=e.points[i.relationNodesIndex[0]],r=e.points[i.index],o=Math.sqrt((n.x-r.x)*(n.x-r.x)+(n.y-r.y)*(n.y-r.y)),s=(n.y-r.y)/o,a=(n.x-r.x)/o;return 0===s&&1===a||0===s&&-1===a?{flag:"y"}:{flag:"x"}}return P.config={version:"1.1.0"},P.Util={},P.Util.createDiv=function(t,e,i,n){var r=document.createElement("div");return r.id=t,r.style.width=e+"px",r.style.height=i+"px",n&&(r.style.position="absolute"),r.style.zIndex=1,r},P.Util.getDpr=function(){return window.devicePixelRatio||1},P.Util.createCanvas=function(t,e,i,n){var r=document.createElement("canvas"),o=P.Util.getDpr();return r.id=t,r.width=e*o,r.height=i*o,r.style.width=e+"px",r.style.height=i+"px",n&&(r.style.position="absolute"),r},P.Util.transformScreenXYWithDpr=function(t){var e=P.Util.getDpr();return{x:t.x*e,y:t.y*e}},P.Util.isInArray=function(t,e){for(var i in t)if(t[i]===e)return!0;return!1},P.Util.isObjInArray=function(t,e){for(var i in t)if(t[i].id===e.id)return alert("已被添加，请更换图层id"+e.id),!0;return!1},P.Util.setStyle=function(t,e){var i=P.Util.getDpr();return t.fillStyle=e.fillColor,t.strokeStyle=e.strokeColor,t.lineWidth=e.lineWeight*i,t.globalAlpha=e.opacity,!0},P.Util.worldToScreen=function(t,e,i){var n=t.getCenter(),r=n.x,o=n.y,s=parseInt(t.w,10)/2,a=parseInt(t.h,10)/2,l=t.zoom/parseInt(t.w,10);return{x:parseFloat(s)+parseFloat((e-r)/l)+0,y:parseFloat(a)-parseFloat((i-o)/l)+0}},P.Util.screenToWorld=function(t,e,i){var n=t.getCenter(),r=n.x,o=n.y,s=parseInt(t.w,10)/2,a=parseInt(t.h,10)/2,l=t.zoom/parseInt(t.w,10);return{x:parseFloat(r)+parseFloat((e-s)*l),y:parseFloat(o)-parseFloat((i-a)*l)}},P.Util.addEvtHandler=function(t,e,i){t["on"+e]=i,"mousewheel"===e&&0===P.Util.getIEVersion()&&t.addEventListener("DOMMouseScroll",i,!1)},P.Util.removeEvtHandler=function(t,e){t["on"+e]=null},P.Util.getMouseXY=function(t,e){var i=0,n=0,r=e.srcElement?e.srcElement:e.target;if(1!==r.nodeType)return{x:i,y:n};if(document.attachEvent){var o="medium"===P.Util.getEleStyle(r,"border-top-width")?0:P.Util.delpx(P.Util.getEleStyle(r,"border-top-width")),s="medium"===P.Util.getEleStyle(r,"border-left-width")?0:P.Util.delpx(P.Util.getEleStyle(r,"border-left-width"));i=e.layerX-s,n=e.layerY-o}else{for(;r&&r!==t;){var a="medium"===P.Util.getEleStyle(r,"border-top-width")?0:P.Util.delpx(P.Util.getEleStyle(r,"border-top-width")),l="medium"===P.Util.getEleStyle(r,"border-left-width")?0:P.Util.delpx(P.Util.getEleStyle(r,"border-left-width"));i+=r.offsetLeft+l,n+=r.offsetTop+a,r=r.offsetParent}i=e.offsetX+i+document.body.scrollLeft,n=e.offsetY+n+document.body.scrollTop}return{x:i,y:n}},P.Util.getMousePos=function(t){var e=t||window.event;return{x:e.screenX,y:e.screenY}},P.Util.getEleStyle=function(t,e){var i=e.split("-"),n=i[0];if(1<n.length)for(var r=1;r<i.length;r++)n+=i[r].substring(0,1).toUpperCase()+i[r].substring(1);else n=e;return t.currentStyle?t.currentStyle[n]:document.defaultView.getComputedStyle(t,!1)[n]},P.Util.delpx=function(t){return t?parseInt(t.substring(0,t.length-2),10):0},P.Util.getRectPointsWithSAndE=function(t,e){var i=e.x,n=t.y,r=t.x,o=e.y;return[{x:t.x,y:t.y},{x:i,y:n},{x:e.x,y:e.y},{x:r,y:o}]},P.Util.pointInPoly=function(t,e){for(var i=!1,n=-1,r=e.length,o=r-1;++n<r;o=n)(e[n].y<=t.y&&t.y<e[o].y||e[o].y<=t.y&&t.y<e[n].y)&&t.x<(e[o].x-e[n].x)*(t.y-e[n].y)/(e[o].y-e[n].y)+e[n].x&&(i=!i);return i},P.Util.preventDefault=function(t){t.preventDefault?t.preventDefault():window.event.returnValue=!1},P.Util.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():window.event.cancelBubble=!0},P.Util.getButton=function(t){if(t=t||window.event,!+[1])switch(t.button){case 0:case 1:case 3:case 5:case 7:return 0;case 2:case 6:return 2;case 4:return 1}return t.button},P.Util.createTextArea=function(t,e,i,n){var r=document.createElement("textarea");return r.id=t,r.style.width=e+"px",r.style.height=i+"px",r.style.resize="none",n&&(r.style.position="absolute"),r.style.zIndex=1,r},P.Util.colorRgb=function(t,e){return"rgba("+parseInt("0x"+t.slice(1,3))+","+parseInt("0x"+t.slice(3,5))+","+parseInt("0x"+t.slice(5,7))+","+e+")"},P.Util.getIEVersion=function(){var t=window.navigator.userAgent.toLowerCase();return/msie 8\.0/i.test(t)?8:/msie 7\.0/i.test(t)?7:/msie 6\.0/i.test(t)?6:0},P.Util.formatGeoPointsWithDlt=function(t,e,i,n){for(var r=e.length,o=t.getZoom()/t.getSize().w,s=i*o,a=n*o,l=[],h=0;h<r;h++){var u=e[h];l.push({x:u.x+s,y:u.y-a})}return l},P.Util.formatGeoPointsWithDeleteIndex=function(t,e){for(var i=t.length,n=[],r=0;r<i;r++){var o=t[r];(r!==e||i<=3)&&n.push({x:o.x,y:o.y})}return n},P.Util.calRectNewPointsWithNodesIndexTmpPoint=function(t,e,i,n,r){for(var o=e.length,s=t.getZoom()/t.getSize().w,a=n*s,l=r*s,h=[],u=[],c=0;c<o;c++){var y=e[c],f=P.Util.worldToScreen(t,y.x,y.y);i.includes(c)?(h.push({x:y.x+a,y:y.y-l}),u.push({x:f.x+n,y:f.y+r})):(h.push({x:y.x,y:y.y}),u.push({x:f.x,y:f.y}))}return{points:h,sPoints:u}},P.Util.calPolygonNewPointsWithNodesIndexTmpPoint=function(t,e,i,n){for(var r=e.length,o=[],s=[],a=0;a<r;a++){var l=e[a],h=P.Util.worldToScreen(t,l.x,l.y);if(o.push({x:l.x,y:l.y}),s.push({x:h.x,y:h.y}),a===i){o.push({x:n.x,y:n.y});var u=P.Util.worldToScreen(t,n.x,n.y);s.push({x:u.x,y:u.y})}}return{points:o,sPoints:s}},P.Util.calRectNewPointsWithNodesIndexFormalPoint=function(t,e,i,n,r,o,s){for(var a=e.length,l=t.getZoom()/t.getSize().w,h=r*l,u=o*l,c=[],y=[],f=0;f<a;f++){var d=e[f],p=P.Util.worldToScreen(t,d.x,d.y),v=i.indexOf(f);"y"===s&&0===v||"x"===s&&1===v?(c.push({x:d.x,y:d.y-u}),y.push({x:p.x,y:p.y+o})):"y"===s&&1===v||"x"===s&&0===v?(c.push({x:d.x+h,y:d.y}),y.push({x:p.x+r,y:p.y})):f===n?(c.push({x:d.x+h,y:d.y-u}),y.push({x:p.x+r,y:p.y+o})):(c.push({x:d.x,y:d.y}),y.push({x:p.x,y:p.y}))}return{points:c,sPoints:y}},P.Util.calPolygonNewPointsWithNodesIndexFormalPoint=function(t,e,i,n,r){for(var o=e.length,s=t.getZoom()/t.getSize().w,a=n*s,l=r*s,h=[],u=[],c=0;c<o;c++){var y=e[c],f=P.Util.worldToScreen(t,y.x,y.y);c===i?(h.push({x:y.x+a,y:y.y-l}),u.push({x:f.x+n,y:f.y+r})):(h.push({x:y.x,y:y.y}),u.push({x:f.x,y:f.y}))}return{points:h,sPoints:u}},P.Util.getBounds=function(t){if(!t.length)return[];for(var e=t[0].x,i=t[0].y,n=t[0].x,r=t[0].y,o=1;o<t.length;o++)e>t[o].x&&(e=t[o].x),n<t[o].x&&(n=t[o].x),i>t[o].y&&(i=t[o].y),r<t[o].y&&(r=t[o].y);return[{x:e,y:r},{x:n,y:r},{x:n,y:i},{x:e,y:i}]},P.Util.Key={},P.Util.Key.EVENT="on",P.Util.Key.FLAG={},P.Util.Key.EVENTS={},P.Util.Key.addEventListener=function(t,e){var i=t.join("_");P.Util.Key.EVENTS[i]=e},P.Util.Key.removeEventListener=function(t){var e=t.join("_");delete P.Util.Key.EVENTS[e]},document.addEventListener("keydown",function(t){var e=t.keyCode;if(P.Util.Key.FLAG[e]=!0,"off"!==P.Util.Key.EVENT)for(var i in P.Util.Key.EVENTS){var n=i.split("_"),r=P.Util.Key.EVENTS[i],o=!0;n.forEach(function(t){P.Util.Key.FLAG[1*t]||(o=!1)}),o&&r()}}),document.addEventListener("keyup",function(t){var e=t.keyCode;P.Util.Key.FLAG[e]=!1}),P.Util.Key.isActive=function(t){return P.Util.Key.FLAG[t+""]},P.Graph={},P.Graph.drawPoint=function(t,e){var i=P.Util.transformScreenXYWithDpr(e),n=P.Util.getDpr();t.beginPath(),t.arc(i.x,i.y,3*n,0,2*Math.PI,!0),t.closePath(),t.fill()},P.Graph.drawPoints=function(t,e){for(var i=0;i<e.length;i++){var n={x:e[i].x,y:e[i].y};this.drawPoint(t,n)}},P.Graph.drawLine=function(t,e,i){t.beginPath();var n=P.Util.transformScreenXYWithDpr(e),r=P.Util.transformScreenXYWithDpr(i);t.moveTo(n.x,n.y),t.lineTo(r.x,r.y),t.closePath(),t.stroke()},P.Graph.drawRect=function(t,e,i,n){var r=P.Util.getDpr(),o=P.Util.transformScreenXYWithDpr(e);t.strokeRect(o.x,o.y,i*r,n*r)},P.Graph.drawPolygon=function(t,e){var i=e.length;if(2<=i){t.beginPath();var n=P.Util.transformScreenXYWithDpr(e[0]);t.moveTo(n.x,n.y);for(var r=1;r<i;r++)n=P.Util.transformScreenXYWithDpr(e[r]),t.lineTo(n.x,n.y);t.closePath()}t.stroke()},P.Graph.drawGeoPoint=function(t,e,i){var n=P.Util.worldToScreen(t,i.x,i.y),r=P.Util.transformScreenXYWithDpr(n),o=P.Util.getDpr();e.beginPath(),e.arc(r.x,r.y,3*o,0,2*Math.PI,!0),e.closePath(),e.fill()},P.Graph.drawGeoLineWith=function(t,e,i,n){var r=P.Util.worldToScreen(t,i.x,i.y),o=P.Util.worldToScreen(t,n.x,n.y),s=P.Util.transformScreenXYWithDpr(r),a=P.Util.transformScreenXYWithDpr(o);e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(a.x,a.y),e.closePath(),e.stroke()},P.Graph.drawGeoPoints=function(t,e,i){for(var n=0;n<i.length;n++){var r=P.Util.worldToScreen(t,i[n].x,i[n].y);this.drawPoint(e,r)}},P.Graph.drawGeoPolygon=function(t,e,i){var n=i.length;if(2<=n){e.beginPath();var r=P.Util.worldToScreen(t,i[0].x,i[0].y),o=P.Util.transformScreenXYWithDpr(r);e.moveTo(o.x,o.y);for(var s=1;s<n;s++){var a=P.Util.worldToScreen(t,i[s].x,i[s].y),l=P.Util.transformScreenXYWithDpr(a);e.lineTo(l.x,l.y)}e.closePath()}e.stroke()},P.Graph.drawDashGeoPolygon=function(t,e,i){var n=i.length;if(2<=n){e.beginPath();var r=P.Util.worldToScreen(t,i[0].x,i[0].y),o=P.Util.transformScreenXYWithDpr(r);e.moveTo(o.x,o.y);for(var s=1;s<n;s++){var a=P.Util.worldToScreen(t,i[s].x,i[s].y),l=P.Util.transformScreenXYWithDpr(a);if(e.lineTo(l.x,l.y),s===n-1){if(e.stroke(),n<=2)return;var h=e.globalAlpha;e.setLineDash([10,20]),e.globalAlpha=.3,e.beginPath(),e.moveTo(l.x,l.y),e.lineTo(o.x,o.y),e.stroke(),e.setLineDash([]),e.globalAlpha=h}}}},P.Graph.drawText=function(t,e,i,n){var r=P.Util.transformScreenXYWithDpr({x:i,y:n});e.fillText(t,r.x,r.y)},P.Graph.drawGeoText=function(t,e,i,n,r){var o=P.Util.worldToScreen(t,n,r),s=P.Util.transformScreenXYWithDpr(o);i.fillText(e,s.x,s.y)},P.Geometry=o.extend({init:function(t){this.name=t},getVertices:function(){},getBounds:function(){},calcBounds:function(){}}),P.Geometry.Point=o.extend({init:function(t,e){this.x=t,this.y=e,this.className="point"}}),P.Geometry.LineString=P.Geometry.extend({init:function(t){this.className="line",this.points=[];for(var e=0;e<t.length;e++){var i=t[e];i instanceof P.Geometry.Point?this.points.push(i):alert("初始化节点失败！")}},addPoint:function(t,e){/^\d+$/.test(e)?this.points.splice(e,0,t):this.points.push(t)},delPoint:function(t){this.points.splice(t,1)},removePoint:function(t){for(var e=0;e<this.points.length;e++)if(this.points[e]===t){this.points.splice(e,1);break}},getLength:function(){for(var t=this.points.length,e=0,i=0;i<t-1;i++){e+=Math.sqrt((this.points[i].x-this.points[i+1].x)*(this.points[i].x-this.points[i+1].x)+(this.points[i].y-this.points[i+1].y)*(this.points[i].y-this.points[i+1].y))}return e}}),P.Geometry.LinearRing=P.Geometry.LineString.extend({init:function(t){if(t.length<=2)alert("组成多边形节点个数不足！");else{this._super(t),this.className="polygon";var e=t[0];this.points.push(e)}},addPoint:function(t,e){this.points.splice(e,0,t)},delPoint:function(t){if(4!==this.points.length){if(this.points.splice(t,1),0===t){this.points.pop();var e=this.points[0];this.points.push(e)}}else alert("节点数低于3个，不能删除！")},getCenterPoint:function(){for(var t=this.points,e=t.length,i=0,n=0,r=0;r<e;r++)i+=t[r].x,n+=t[r].y;var o=i/e,s=n/e;return new P.Geometry.Point(o,s)},getArea:function(){for(var t=0,e=this.points,i=0;i<e.length;i++)t+=e[i].x*e[(i+1)%e.length].y-e[(i+1)%e.length].x*e[i].y;return parseInt(Math.abs(.5*t),10)}}),P.Geometry.RectRing=P.Geometry.LineString.extend({init:function(t){t.length<4?alert("组成矩形节点个数不足！"):(this._super(t),this.className="rect")},addPoint:function(t,e){this.points.splice(e,0,t)},delPoint:function(t){if(4!==this.points.length){if(this.points.splice(t,1),0===t){this.points.pop();var e=this.points[0];this.points.push(e)}}else alert("节点数低于3个，不能删除！")},getArea:function(){for(var t=0,e=this.points,i=0;i<e.length;i++)t+=e[i].x*e[(i+1)%e.length].y-e[(i+1)%e.length].x*e[i].y;return parseInt(Math.abs(.5*t),10)}}),P.Geometry.RadiusRing=P.Geometry.extend({init:function(t,e){this.radius=e,this.centerPoint=t,this.className="radius"},getArea:function(){return 6.28318*this.radius*this.radius}}),P.Feature=o.extend({init:function(t,e,i,n){this.activeSatus=!1,this.hoverStatus=!1,this.visible=!1,this.id=t,this.points=e,this.data=i||{},this.gStyle=n},onAdd:function(t){this._layerID=t.id,this._layer=t,this.visible=!0,this.setEditVertices(),this.style=this.gStyle||t.featureStyle||new P.Style({}),this.hoveStyle=t.featureHoverStyle||new P.Style({strokeColor:"#FF0000",lineWeight:1}),this.activeStyle=t.featureActiveStyle||new P.Style({strokeColor:"#FF0000",lineWeight:1}),this.onDraw(t)},onRemove:function(t){},getVertices:function(){return this.points},setEditVertices:function(){for(var t=this.points,e=t.length,i=this._layer.getMap(),n=[],r=0;r<e-1;r++){var o=t[r],s=t[r+1],a=-1<r-1?r-1:e-1,l=(t[a].y-s.y)/(t[a].x-s.x);n.push({point:o,sPoint:P.Util.worldToScreen(i,o.x,o.y),type:"formal",index:r,k:-1/l,relationNodesIndex:[a,r+1]});var h={x:(o.x+s.x)/2,y:(o.y+s.y)/2},u=(s.y-o.y)/(s.x-o.x);if(n.push({point:h,sPoint:P.Util.worldToScreen(i,h.x,h.y),type:"tmp",index:r,k:-1/u,relationNodesIndex:[r,r+1]}),r===e-2){var c=(t[0].y-o.y)/(t[0].x-o.x);n.push({point:s,sPoint:P.Util.worldToScreen(i,s.x,s.y),type:"formal",index:r+1,k:-1/c,relationNodesIndex:[r,0]});var y=t[0],f={x:(y.x+s.x)/2,y:(y.y+s.y)/2},d=(t[0].y-s.y)/(t[0].x-s.x);n.push({point:f,sPoint:P.Util.worldToScreen(i,f.x,f.y),type:"tmp",index:r,k:-1/d,relationNodesIndex:[r+1,0]})}}this._editPoints=n},catchPointWithPos:function(t){if(!this.visible)return{flag:!1,point:null};for(var e=this._editPoints,i=this._layer.getMap(),n=P.Util.worldToScreen(i,t.x,t.y),r=e.length,o=0;o<r;o++){var s=e[o].sPoint,a=(n.x-s.x)*(n.x-s.x)+(n.y-s.y)*(n.y-s.y);if(Math.sqrt(a)<=10)return{flag:!0,point:e[o]}}return{flag:!1,point:null}},show:function(){this.visible||(this.visible=!0,this._layer.renew())},hide:function(){this.visible&&(this.visible=!1,this._layer.renew())},update:function(t){this.points=t.points||this.points,this.data=t.data||this.data,this.style=t.style||this.style,t.points&&this.setEditVertices(),this._layer.renew()},pointInFeature:function(t){return!(!P.Util.pointInPoly(t,this.points)||!this.visible)},hover:function(t){this.hoverStatus||(this.hoveStyle=t||this.hoveStyle,this.hoverStatus=!0,this._layer.renew())},deHover:function(){this.hoverStatus&&(this.hoverStatus=!1,this._layer.renew())},active:function(t){this.activeSatus||(this.activeStyle=t||this.activeStyle,this.activeSatus=!0,this._layer.renew())},deActive:function(){this.activeSatus&&(this.activeSatus=!1,this._layer.renew())},getStyle:function(){return this.activeSatus||this.hoverStatus,this.style},onDraw:function(t){if(this.visible){var e=t.getCtx(),i=this.getStyle(),n=P.Util.getDpr();P.Util.setStyle(e,i),this.hoverStatus&&!this.activeSatus&&(e.lineWidth=2*i.lineWeight*n),i.lineDash?e.setLineDash([10,5]):e.setLineDash([]);var r=t.getMap();e.globalAlpha=1,this.activeSatus&&(e.strokeStyle="#FF0000");var o=this.points.length;if(2<=o){e.beginPath();var s=P.Util.worldToScreen(t._map,this.points[0].x,this.points[0].y),a=P.Util.transformScreenXYWithDpr(s);e.moveTo(a.x,a.y);for(var l=1;l<o;l++)s=P.Util.worldToScreen(t._map,this.points[l].x,this.points[l].y),a=P.Util.transformScreenXYWithDpr(s),e.lineTo(a.x,a.y);e.closePath()}if(e.stroke(),t._opacity?e.globalAlpha=0:e.globalAlpha=this.style.opacity,e.fill(),this.activeSatus){var h=this._editPoints.filter(function(t){return"formal"===t.type}),u=this._editPoints.filter(function(t){return"tmp"===t.type});e.globalAlpha=1,e.fillStyle="#FF0000",P.Graph.drawGeoPoints(r,e,h.map(function(t){return t.point})),e.globalAlpha=1,e.fillStyle="#FF9900",P.Graph.drawGeoPoints(r,e,u.map(function(t){return t.point}))}}},getBounds:function(){for(var t=this.getVertices(),e=t[0].x,i=t[0].y,n=t[0].x,r=t[0].y,o=1;o<t.length;o++)e>t[o].x&&(e=t[o].x),n<t[o].x&&(n=t[o].x),i>t[o].y&&(i=t[o].y),r<t[o].y&&(r=t[o].y);return[{x:e,y:r},{x:n,y:r},{x:n,y:i},{x:e,y:i}]},calcBounds:function(){}}),P.Feature.Rect=P.Feature.extend({init:function(t,e,i,n){this._super(t,e,i,n),this.type="rect"}}),P.Feature.Polygon=P.Feature.extend({init:function(t,e,i,n){this._super(t,e,i,n),this.type="polygon"}}),P.Marker=o.extend({init:function(t,e){this.id=t,this._img=new Image,this._img.src=e.src,this.src=e.src,this._img.style.position="absolute",this._img.style.zIndex=100,this.info=e},onAdd:function(t){var e=(this._layer=t).getMap(),i=this._container=t.getLayerContainer();this.x=this.info.x,this.y=this.info.y;var n=P.Util.worldToScreen(e,this.info.x,this.info.y);this._img.style.left=n.x+this.info.offset.x+"px",this._img.style.top=n.y+this.info.offset.y+"px",this._img.style.cursor="pointer",i.appendChild(this._img)},onRemove:function(){this._container.removeChild(this._img)},update:function(t){t.src&&(this._img.src=t.src),t.x&&(this.info.x=t.x),t.y&&(this.info.y=t.y),t.offset&&(this.info.offset=t.offset),this.renew()},regEvent:function(t,e){if("click"===t){var i=this;P.Util.addEvtHandler(this._img,"mousedown",function(t){P.Util.preventDefault(t),P.Util.stopPropagation(t)}),P.Util.addEvtHandler(this._img,"mouseup",function(t){0===P.Util.getButton(t)&&e.apply(i,arguments),P.Util.preventDefault(t),P.Util.stopPropagation(t)}),P.Util.addEvtHandler(this._img,"click",function(t){P.Util.preventDefault(t),P.Util.stopPropagation(t)})}},renew:function(){var t=this._layer.getMap(),e=P.Util.worldToScreen(t,this.info.x,this.info.y);this._img.style.left=e.x+this.info.offset.x+"px",this._img.style.top=e.y+this.info.offset.y+"px"},showInfo:function(){console.log("Hello ...")}}),P.Text=o.extend({init:function(t,e,i){this.id=t,this.startPoint=e.pos,this.offset=e.offset||{x:0,y:0},this.boxMaxWidth=e.width,this.wrap=e.wrap||!1,this.text=e.text,this.style=i||new P.Style({})},onAdd:function(t){var e=this.id;this._w=this.boxMaxWidth;var i=P.Util.createDiv(e,this._w,this._h,!0);i.style.borderWidth=0,i.style.width="initial",i.style.maxWidth=this._w+"px",this.wrap||(i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.style.whiteSpace="nowrap"),this._textContainer=i,(this._container=t.getLayerContainer()).appendChild(this._textContainer),this._layer=t,this.onDraw(t)},update:function(t){t.pos&&(this.startPoint=t.pos),t.offset&&(this.offset=t.offset),t.text&&(this.text=t.text),t.width&&(this.boxMaxWidth=t.width),t.style&&(this.style=t.style),this.renew()},onDraw:function(t){var e=P.Util.worldToScreen(t._map,this.startPoint.x,this.startPoint.y);e.x=e.x+this.offset.x,e.y=e.y+this.offset.y,this._textContainer.style.fontSize=this.style.fontSize+"px",this._textContainer.style.lineHeight=this.style.fontSize+"px",this._textContainer.style.fontFamily=this.style.fontFamily+",SimSun",this._textContainer.style.color=this.style.fontColor,this._textContainer.style.borderRadius="1px",this._textContainer.style.boxSizing="border-box",this._textContainer.style.padding="1px";var i=this.style.opacity||0===this.style.opacity?this.style.opacity:1,n=P.Util.colorRgb(this.style.bgColor,i);this._textContainer.style.background=n,this._textContainer.textContent=this.text,this._textContainer.style.left=e.x+"px",this._textContainer.style.top=e.y+"px",t._layerContainer.appendChild(this._textContainer)},setText:function(t){this.text=t,this.refresh()},setPosition:function(t,e){this.startPoint.x=t,this.startPoint.y=e},setSize:function(t){this._w=this.boxMaxWidth=t},onRemove:function(){this._container.removeChild(this._textContainer)},getContainer:function(){return this._textContainer},renew:function(){var t=this._layer;this.onDraw(t)},refresh:function(){this.renew()}}),P.Style=o.extend({init:function(t){this.oStyle="singleStyle",this.fillColor=t.fillColor?t.fillColor:"#00DD00",this.strokeColor=t.strokeColor?t.strokeColor:"#00DD00",this.lineWeight=t.lineWeight?t.lineWeight:1,this.borderStatus=!t.borderStatus||t.borderStatus,this.cirRadius=t.cirRadius?t.cirRadius:3,this.fillStatus=!t.fillStatus||t.fillStatus,this.vtxStatus=!!t.vtxStatus&&t.vtxStatus,this.vtxRadius=t.vtxRadius?t.vtxRadius:3,this.tlr=t.tlr?t.tlr:5,this.opacity=t.opacity||0===t.opacity?t.opacity:1,this.mappingValue=t.mappingValue?t.mappingValue:"default",this.fontSize=t.fontSize?t.fontSize:13,this.fontFamily=t.fontFamily?t.fontFamily:"KaiTi",this.fontColor=t.fontColor?t.fontColor:"#333333",this.bgColor=t.bgColor?t.bgColor:"#ffffff",this.lineDash=t.lineDash||!1}}),P.StyleEx=o.extend({init:function(t,e){this.oStyle="multiStyles",this.styles=t,this.mappingField=e}}),P.Edit={},P.Edit.mouseDown=function(t,e){var i=P.Util.getMouseXY(t._container,e),n=P.Util.screenToWorld(t,i.x,i.y),r=t.mode;switch(r){case"drawRect":case"drawPolygon":if(t.activeFeature){var o=t.activeFeature.type;if("rect"===o)t.dragging=!0;else if("polygon"===o){var s=P.Util.getButton(e),a=t.activePoint;if(a&&"formal"===a.type&&2===s){var l=t.activeFeature.points,h=P.Util.formatGeoPointsWithDeleteIndex(l,t.activePoint.index);t.userGeometryEditDone&&t.userGeometryEditDone("polygon",t.activeFeature,h)}else t.dragging=!0}}else{t.resetLayerStatus("active");var u=new P.Geometry.Point(n.x,n.y);"drawRect"===r?t.drawGeometryPoints.push(u):"drawPolygon"===r&&(t.tipLayer.setGeoText("ctrl+z撤销",n.x,n.y),t.drawGeometryPoints.push(u))}}},P.Edit.mouseMove=function(t,e){var i=t.overLayer.getCtx(),n=e.srcElement?P.Util.getMouseXY(t._container,e):e,r=P.Util.screenToWorld(t,n.x,n.y),o=n.x-t.startX,s=n.y-t.startY,a=t.mode,l=t.drawGeometryPoints,h=l.length;switch(a){case"drawRect":case"drawPolygon":t.overLayer.clear(),t.tipLayer.clear(),t.globalStyle?P.Util.setStyle(i,t.globalStyle):t.overLayer.setInitStyle();var u=t.activeFeature,c=t.hoverFeature;if(u){var y=t.activePoint,f=u.points,d=u.type;if(t.dragging)if(t.overLayer.setEditStyle(),t.overLayer.topzIndex(),u.visible&&u.hide(),y){var p=[],v=t.activePoint,x=v.type,g=v.relationNodesIndex,m=v.index;if("tmp"===x)if("rect"===d){var w=T(t,o,s);p=P.Util.calRectNewPointsWithNodesIndexTmpPoint(t,f,g,w.dltx,w.dlty)}else"polygon"===d&&(p=P.Util.calPolygonNewPointsWithNodesIndexTmpPoint(t,f,g[0],r));else if("formal"===x)if("rect"===d){var S=I(t);p=P.Util.calRectNewPointsWithNodesIndexFormalPoint(t,f,g,m,o,s,S.flag)}else"polygon"===d&&(p=P.Util.calPolygonNewPointsWithNodesIndexFormalPoint(t,f,m,o,s));P.Graph.drawPolygon(i,p.sPoints),t.userGeometryEditing&&t.userGeometryEditing(d,u,p.points)}else{var _=P.Util.formatGeoPointsWithDlt(t,f,o,s);P.Graph.drawGeoPolygon(t,i,_),t.userGeometryEditing&&t.userGeometryEditing(d,u,_)}else y&&"formal"===y.type&&3<f.length&&t.tipLayer.setGeoText("右键删除节点",r.x,r.y)}else if(0<h)if(t.overLayer.topzIndex(),"drawRect"===a)P.Graph.drawRect(i,{x:t.startX,y:t.startY},o,s);else{1<h&&t.tipLayer.setGeoText("双击结束绘制",r.x,r.y);var U=[].concat(C(l),[r]);P.Graph.drawDashGeoPolygon(t,i,U)}else c&&t.tipLayer.setGeoText("双击选择编辑",r.x,r.y)}return!0},P.Edit.mouseUp=function(t,e){var i=P.Util.getMouseXY(t._container,e),n=P.Util.screenToWorld(t,i.x,i.y),r=i.x-t.startX,o=i.y-t.startY,s=t.mode;switch(s){case"drawRect":case"drawPolygon":var a=t.activeFeature,l=t.activePoint,h=t.dragging;if(a){var u=a.points,c=a.type,y="drawRect"===s?"rect":"polygon";if(h){t.overLayer.clear();var f=[];if(l){var d=l.type,p=l.relationNodesIndex,v=l.index,x=[];if("tmp"===d)if("rect"===c){var g=T(t,r,o);x=P.Util.calRectNewPointsWithNodesIndexTmpPoint(t,u,p,g.dltx,g.dlty)}else"polygon"===c&&(x=P.Util.calPolygonNewPointsWithNodesIndexTmpPoint(t,u,p[0],n));else if("formal"===d)if("rect"===c){var m=I(t);x=P.Util.calRectNewPointsWithNodesIndexFormalPoint(t,u,p,v,r,o,m.flag)}else"polygon"===c&&(x=P.Util.calPolygonNewPointsWithNodesIndexFormalPoint(t,u,v,r,o));f=x.points}else f=P.Util.formatGeoPointsWithDlt(t,u,r,o);t.userGeometryEditDone&&t.userGeometryEditDone(y,t.activeFeature,f),t.dragging=!1}}else if(0<t.drawGeometryPoints.length&&"drawRect"===s){t.overLayer.clear();var w=t.drawGeometryPoints[0],S=new P.Geometry.Point(n.x,n.y),_=P.Util.getRectPointsWithSAndE(w,S);Math.abs(_[0].x-_[2].x)<2||Math.abs(_[0].y-_[2].y)<2?(t.drawGeometryPoints=[],console.log("invalid points data: 绘制矩形 —— 不是有效矩形框...")):t.drawGeometryPoints=_}}},P.Edit.mouseDblClick=function(t,e){switch(t.mode){case"drawRect":t.tipLayer.clear();break;case"drawPolygon":t.overLayer.clear(),t.tipLayer.clear(),t.drawGeometryPoints.pop(),3<=t.drawGeometryPoints.length||(t.drawGeometryPoints=[],console.log("invalid points data: 绘制多边形 —— 不是有效多边形..."))}},P.Map=o.extend({init:function(t,e){this._options=e||{},this.privateInitContainer(t),this.privateInitProp(),this.privateInitEvent(),this.overLayer=new P.Layer.Overlay("overlay"),this.tipLayer=new P.Layer.Tip("tip"),this.mLayer=new P.Layer.Marker("markerLayer"),this.addLayer(this.overLayer),this.addLayer(this.tipLayer),this.addLayer(this.mLayer),this.attachEvents(),this.registerShortKeyEvent()},attachEvents:function(){var e=this;e.events={on:function(t,n){switch(t){case"mouseDown":e.userMouseDown=function(t){var e=n(t);return"boolean"!=typeof e||e};break;case"mouseMove":e.userMouseMove=function(t){n(t)};break;case"geometryEditing":e.userGeometryEditing=function(t,e,i){n(t,e,i)};break;case"geometryEditDone":e.userGeometryEditDone=function(t,e,i){n(t,e,i)};break;case"geometryDrawDone":e.userGeometryDrawDone=function(t,e){n(t,e)};break;case"featureHover":e.userFetureHover=function(t){n(t)};break;case"featureSelected":e.userFetureSelected=function(t){n(t)};break;case"featureStatusReset":e.userFeatureStatusReset=function(t){n(t)}}}}},registerShortKeyEvent:function(){var t=this;P.Util.Key.addEventListener([17,90],function(){"drawPolygon"===t.mode&&t.drawGeometryPoints.length&&(t.drawGeometryPoints.pop(),P.Edit.mouseMove(t,{x:t.middleX,y:t.middleY}))})},privateInitContainer:function(t){this._container=document.getElementById(t),this._container.innerHTML="",this.w=this._options.w||this._container.clientWidth,this.h=this._options.h||this._container.clientHeight,this._container.style.overflow="hidden",this._container.style.userSelect="none",this._container.oncontextmenu=function(){return!1}},getContainer:function(){return this._container},getSize:function(){return{w:this.w,h:this.h}},privateInitProp:function(){this.mode="pan",this.dragging=!1,this.oLayers=[],this.zoom=this._options.zoom||parseInt(1*this.w,10),this.cx=this._options.cx||0,this.cy=this._options.cy||0,this.startX=0,this.startY=0,this.startScrX=0,this.startSrcY=0,this.middleX=0,this.middleY=0,this.zoomScale=.025,this.zoomMax=this._options.zoomMax||1e9,this.zoomMin=this._options.zoomMin||0,this.drawGeometryPoints=[],this.activeFeature=null,this.activePoint=null},privateInitEvent:function(){var y=this,t=this._container;P.Util.addEvtHandler(t,"mousedown",function(t){var e=t||window.event;window.event||e.preventDefault();var i=P.Util.getMouseXY(y._container,e),n=P.Util.screenToWorld(y,i.x,i.y),r=P.Util.getMousePos(e);y.startX=i.x,y.startY=i.y,y.startScrX=r.x,y.startScrY=r.y,"pan"===y.mode?(y.resetLayerStatus("active"),function(t){y.dragging=!0;for(var e=y.getAllLayers(),i=0;i<e.length;i++)e[i].startLeft=P.Util.delpx(e[i]._layerContainer.style.left),e[i].startTop=P.Util.delpx(e[i]._layerContainer.style.top)}(),document.onmousemove=function(t){!function(t){var e=P.Util.getMousePos(t);if(y.dragging){var i=e.x-y.startScrX,n=e.y-y.startScrY,r=y.getAllLayers();if(0<Math.abs(i)||0<Math.abs(n))for(var o=0;o<r.length;o++)r[o].onDrag(i,n)}}(t)},document.onmouseup=function(t){document.onmousemove=null,document.onmouseup=null,function(t){var e=P.Util.getMousePos(t),i=e.x-y.startScrX,n=e.y-y.startScrY;if(0<Math.abs(i)||0<Math.abs(n)){var r=y.getScreenCenter(),o=r.x-i,s=r.y-n,a=P.Util.screenToWorld(y,o,s);y.setCenter(a.x,a.y);for(var l=y.getAllLayers(),h=0,u=l.length;h<u;h++)l[h].renew()}y.dragging=!1}(t)}):(o=e,P.Edit.mouseDown(y,o));var o;y.userMouseDown&&y.userMouseDown(n)}),P.Util.addEvtHandler(t,"mousemove",function(t){var e=P.Util.getMouseXY(y._container,t),i=P.Util.screenToWorld(y,e.x,e.y);y.middleX=e.x,y.middleY=e.y,!y.dragging&&y.handleDrawEditGeometryMouseMove(i),P.Edit.mouseMove(y,t),y.userMouseMove&&y.userMouseMove(i),!y.dragging&&y.setTargets(i,"hover")}),P.Util.addEvtHandler(t,"mouseup",function(t){var e=P.Util.getMouseXY(y._container,t);P.Util.screenToWorld(y,e.x,e.y);if(P.Edit.mouseUp(y,t),y.drawGeometryPoints.length)switch(y.mode){case"drawRect":y.userGeometryDrawDone&&y.userGeometryDrawDone("rect",y.drawGeometryPoints),y.drawGeometryPoints=[]}else y.overLayer.resetzIndex(),y.mode}),P.Util.addEvtHandler(t,"mousewheel",function(t){P.Util.preventDefault(t);var e=P.Util.getMouseXY(y._container,t),i=P.Util.screenToWorld(y,e.x,e.y);if("pan"===y.mode){var n=t.wheelDelta||-t.detail;if(0<n){if(y.zoom<=this.zoomMin)return;var r=(i.x-y.cx)*(1-y.zoomScale),o=(i.y-y.cy)*(1-y.zoomScale),s=i.x-r,a=i.y-o;y.setCenter(s,a),y.zoomIn(1)}else{if(y.zoom>=this.zoomMax)return;var l=(i.x-y.cx)/(1-y.zoomScale),h=(i.y-y.cy)/(1-y.zoomScale),u=i.x-l,c=i.y-h;y.setCenter(u,c),y.zoomOut(1)}}}),P.Util.addEvtHandler(t,"dblclick",function(t){var e=P.Util.getMouseXY(y._container,t),i=P.Util.screenToWorld(y,e.x,e.y);if(P.Edit.mouseDblClick(y,t),y.drawGeometryPoints.length)switch(y.mode){case"drawRect":break;case"drawPolygon":y.userGeometryDrawDone&&y.userGeometryDrawDone("polygon",y.drawGeometryPoints),y.drawGeometryPoints=[]}else switch(y.mode){case"drawRect":case"drawPolygon":!y.activeFeature&&y.setTargets(i,"selected")}})},handleDrawEditGeometryMouseMove:function(o){var s=this;switch(s.mode){case"pan":s.setCursor("pointer");break;case"drawRect":case"drawPolygon":if(function(){for(var t=s.getAllLayers(),e=0;e<t.length;e++)if("featureLayer"===t[e].oClass){var i=t[e].catchFeaturePointWithPos(o,"active");if(i.length)return s.activeFeature=i[0].feature,s.activePoint=i[0].point,!(s.hoverFeature=null);var n=t[e].getFeaturesWithPos(o,"active");if(n.length)return s.activeFeature=n[0],s.activePoint=null,!(s.hoverFeature=null);var r=t[e].getFeaturesWithPos(o,"hover");if(r.length)return s.activeFeature=null,s.activePoint=null,s.hoverFeature=r[0],!1}return s.activeFeature=null,s.activePoint=null,s.hoverFeature=null,!1}()){var t=s.activeFeature;if(s.activePoint&&"rect"===t.type){var e=s.activePoint.k;0<e&&e!==1/0?s.setCursor("nesw-resize"):0===e?s.setCursor("ew-resize"):e<0&&e!==-1/0?s.setCursor("nwse-resize"):s.setCursor("ns-resize")}else s.activePoint&&"polygon"===t.type?s.setCursor("no-drop"):s.setCursor("move")}else s.setCursor("crosshair")}},setTargets:function(t,e){for(var i=this.getAllLayers(),n=[],r=0;r<i.length;r++)n=n.concat(i[r].getFeaturesWithPos(t));if("selected"===e){if(!n.length)return void this.resetLayerStatus("active");n[0].active(),this.handleDrawEditGeometryMouseMove(t),this.userFetureSelected&&this.userFetureSelected(n[0])}else if("hover"===e){if(this.resetLayerStatus("hover"),!n.length)return;n[0].hover(),this.userFetureHover&&this.userFetureHover(n[0])}return this},resetLayerStatus:function(t){for(var e=this.getAllLayers(),i=!1,n=0;n<e.length;n++)"featureLayer"===e[n].oClass&&e[n].resetFeatureStatus(t)&&(i=!0);return t&&"active"===t&&i&&this.userFeatureStatusReset&&this.userFeatureStatusReset(),i},addLayer:function(t){var e=this.oLayers;P.Util.isObjInArray(e,t)||(t.onAdd(this),e.push(t))},removeLayer:function(t){for(var e=[],i=this.oLayers,n=0,r=0;n<i.length;n++)i[n]!==t?(e[r]=i[n],r++):t.onRemove(this);this.oLayers=e},getAllLayers:function(){return this.oLayers},getNewZoom:function(t,e){for(var i=e||6,n=this.zoom;0<i;)"zoomIn"===t?n-=n*this.zoomScale:n/=1-this.zoomScale,i--;return n},getZoom:function(){return this.zoom},setZoom:function(t){this.zoom=t},zoomIn:function(t){if(!(this.zoom<=this.zoomMin)){var e=this.getAllLayers(),i=this.getNewZoom("zoomIn",t);this.zoom=i;for(var n=0;n<e.length;n++)e[n].zoomIn()}},zoomOut:function(t){if(!(this.zoom>=this.zoomMax)){var e=this.getAllLayers(),i=this.getNewZoom("zoomOut",t);this.zoom=i;for(var n=0;n<e.length;n++)e[n].zoomOut()}},setMode:function(t,e){switch(this.mode=t,this.drawGeometryPoints=[],t){case"pan":this.resetLayerStatus()}e&&(this.globalStyle=e)},setCursor:function(t){var e=this._container.style.cursor;e!==t&&(this.previousCursor=e,this._container.style.cursor=t)},resetCursor:function(){this.setCursor(this.previousCursor)},getMode:function(){return this.mode},setCenter:function(t,e){this.cx=t,this.cy=e},centerAndZoom:function(t,e){this.setCenter(t.x,t.y),this.setZoom(e);for(var i=this.getAllLayers(),n=0;n<i.length;n++)i[n].zoomIn()},getCenter:function(){return{x:this.cx,y:this.cy}},getScreenCenter:function(){return{x:this.w/2,y:this.h/2}},resize:function(t,e){var i=this.zoom/this.w,n=t||this._container.clientWidth,r=e||this._container.clientHeight;this.zoom=i*n,this.w=n,this.h=r;for(var o=this.getAllLayers(),s=0;s<o.length;s++)o[s].resize()},destroy:function(){this._container.innerHTML="";var t=this._container;P.Util.removeEvtHandler(t,"mousedown"),P.Util.removeEvtHandler(t,"mousemove"),P.Util.removeEvtHandler(t,"mouseup"),P.Util.removeEvtHandler(t,"mousewheel")}}),P.Layer=o.extend({init:function(t,e){this.id=t,this.visible=!0,this.options=e||{opacity:1,zIndex:0}},onAdd:function(t){this._map=t,this._container=t.getContainer();var e=t.getSize();this.privateInitLayerContainer(this.id,e.w,e.h),this.privateInitProp(t),this.privateInitParams(t),this._container.appendChild(this._layerContainer),this.setzIndex(),this.setOpacity(this.options.opacity)},onRemove:function(t){t.getContainer().removeChild(this._layerContainer)},privateInitProp:function(t){},privateInitParams:function(t){},onDrag:function(t,e){this._layerContainer.style.left=this.startLeft+t+"px",this._layerContainer.style.top=this.startTop+e+"px"},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},renew:function(){this._layerContainer.style.left="0px",this._layerContainer.style.top="0px"},getSize:function(){return{w:this._layerContainer.clientWidth,h:this._layerContainer.clientHeight}},getScreenCenter:function(){return{x:parseInt(this._layerContainer.clientWidth/2,10),y:parseInt(this._layerContainer.clientHeight/2,10)}},getMap:function(){return this._map},getLayerContainer:function(){return this._layerContainer},setzIndex:function(){isNaN(this.options.zIndex)||(this._layerContainer.style.zIndex=this.options.zIndex)},setOpacity:function(t){this.getLayerContainer().style.opacity=t},resize:function(){this._layerContainer.style.width=this._map.w+"px",this._layerContainer.style.height=this._map.h+"px"},getFeaturesWithPos:function(t){return[]},deSelect:function(){}}),P.Layer.Image=P.Layer.extend({init:function(t,e,i,n){this._super(t,n),this._src=e,this._size=i,this.oClass="imgLayer"},privateInitParams:function(t){},privateInitProp:function(t){this._super(),this._mapImg||(this._mapImg=new Image),this._mapImg.style.position="absolute",this._mapImg.src=this._src,this._mapImg.onmousedown=function(t){t.preventDefault()},this._layerContainer.appendChild(this._mapImg),this.renew()},privateInitLayerContainer:function(t,e,i){var n=P.Util.createDiv(t,e,i,!0);n.style.zIndex=2,this._layerContainer=n},onAdd:function(t){this._super(t)},zoomTo:function(){},renew:function(){this._super();var t=this._map.getSize(),e=this._map.zoom/t.w;this._mapImg.width=this._size.w/e;var i=P.Util.worldToScreen(this._map,-1*this._size.w/2,this._size.h/2);this._mapImg.style.left=i.x+"px",this._mapImg.style.top=i.y+"px"},resize:function(){this._super(),this.renew()},refresh:function(){}}),P.Layer.Feature=P.Layer.extend({init:function(t,e){e=e||{},this._super(t,e),this.featureStyle=e.style||new P.Style({}),this.featureHoverStyle=e.hoverStyle||new P.Style({strokeColor:"#FF0000",lineWeight:1}),this.featureActiveStyle=e.activeStyle||new P.Style({strokeColor:"#FF0000",lineWeight:1}),this._opacity=!!e.transparent&&e.transparent,this.oClass="featureLayer"},privateInitLayerContainer:function(t,e,i){var n=P.Util.createCanvas(t,e,i,!0);this._layerContainer=n,this._ctx=n.getContext("2d"),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},privateInitProp:function(t){this._super()},onAdd:function(t){var e=(this._map=t).getSize(),i=this._map.getContainer();this.privateInitLayerContainer(this.id,e.w,e.h),i.appendChild(this._layerContainer),this.setzIndex(),this.oFeatures=[]},addFeature:function(t){var e=this.getAllFeatures();P.Util.isInArray(e,t)||(e.push(t),t.onAdd(this))},getFeatureById:function(t){for(var e=this.getAllFeatures(),i=e.length-1;0<=i;i--)if(e[i].id===t)return e[i];return null},getFeaturesWithPos:function(t,e){for(var i=[],n=this.getAllFeatures(),r=n.length-1;0<=r;r--){var o=n[r],s=!0;e&&"active"===e&&(s=o.activeSatus),e&&"hover"===e&&(s=!0),o.pointInFeature(t)&&s&&i.push(o)}return i},catchFeaturePointWithPos:function(t,e){for(var i=[],n=this.getAllFeatures(),r=n.length-1;0<=r;r--){var o=n[r],s=!0;e&&"active"===e&&(s=o.activeSatus);var a=o.catchPointWithPos(t);a.flag&&s&&i.push({feature:o,point:a.point})}return i},resetFeatureStatus:function(t){for(var e=this.getAllFeatures(),i=!1,n=e.length-1;0<=n;n--){var r=e[n];t&&"active"===t?r.activeSatus&&(i=!(r.activeSatus=!1)):t&&"hover"===t?r.hoverStatus&&(i=!(r.hoverStatus=!1)):(r.activeSatus||r.hoverStatus)&&(r.activeSatus=!1,i=!(r.hoverStatus=!1))}return i&&this.renew(),i},getActiveFeatures:function(){for(var t=[],e=this.getAllFeatures(),i=e.length-1;0<=i;i--)e[i].activeSatus&&t.push(e[i]);return t},getHoverFeatures:function(){for(var t=[],e=this.getAllFeatures(),i=e.length-1;0<=i;i--)e[i].hoverStatus&&t.push(e[i]);return t},removeAllFeatures:function(){this.oFeatures=[],this.renew()},removeFeature:function(t){for(var e=[],i=0,n=0;i<this.oFeatures.length;i++)this.oFeatures[i]!==t?(e[n]=this.oFeatures[i],n++):t.onRemove(this);this.oFeatures=e,this.renew()},removeFeatureById:function(t){for(var e=[],i=0,n=this.oFeatures.length;i<n;i++){var r=this.oFeatures[i];r.id!==t?e.push(r):r.onRemove(this)}this.oFeatures=e,this.renew()},removeFeaturesByIds:function(t){for(var e=[],i=[],n=0,r=this.oFeatures.length;n<r;n++){var o=this.oFeatures[n];t.includes(o.id)?(o.onRemove(this),i.push(o)):e.push(o)}return this.oFeatures=e,this.renew(),i},removeFeaturesByProperty:function(t){for(var e=[],i=[],n=0,r=this.oFeatures.length;n<r;n++){for(var o=this.oFeatures[n],s=!1,a=0,l=t.length;a<l;a++){var h=t[a];if(o.data[h.key]===h.value){s=!0,o.onRemove(this),i.push(o);break}}s||e.push(o)}return this.oFeatures=e,this.renew(),i},draw:function(){for(var t=this.getAllFeatures(),e=0;e<t.length;e++)t[e].onDraw(this)},renew:function(){this._super(),this.clear(),this.draw()},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},clear:function(){var t=this.getLayerContainer();this._ctx.clearRect(0,0,t.width,t.height)},getAllFeatures:function(){return this.oFeatures},getCtx:function(){return this._ctx}}),P.Layer.Overlay=P.Layer.Feature.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:10},this.zIndexTopFlag=!1,this.oClass="overlayLayer"},setStyle:function(t){this.style=t},initStyle:function(){this.setInitStyle(),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},setInitStyle:function(){var t=this.getCtx(),e=P.Util.getDpr();t.strokeStyle="#0000FF",t.fillStyle="#0000FF",t.lineWidth=1*e,t.globalAlpha=.7},setEditStyle:function(){var t=this.getCtx(),e=P.Util.getDpr();t.strokeStyle="#FF0000",t.lineWidth=1*e,t.globalAlpha=.7},onAdd:function(t){this._super(t),this.initStyle()},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},topzIndex:function(){this.zIndexTopFlag||(this._layerContainer.style.zIndex=9999,this.zIndexTopFlag=!0)},resetzIndex:function(){this.zIndexTopFlag&&(this._layerContainer.style.zIndex=this.options.zIndex,this.zIndexTopFlag=!1)}}),P.Layer.Tip=P.Layer.Feature.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:11},this.oClass="tipLayer"},setStyle:function(t){this.style=t},initStyle:function(){this.setInitStyle(),this._layerContainer.style.left="0",this._layerContainer.style.top="0"},setInitStyle:function(){var t=this.getCtx(),e=12*P.Util.getDpr();t.font="".concat(e,"px Arial"),t.textAlign="left",t.textBaseline="bottom",t.fillStyle="#fff",t.globalAlpha=1},onAdd:function(t){this._super(t),this.initStyle()},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},setTextBackground:function(t,e,i,n){var r=this.getCtx();r.beginPath(),r.rect(t,e,i,n),r.fillStyle="#333",r.fill(),r.lineWidth=1,r.strokeStyle="#efefef",r.stroke()},setText:function(t,e,i){if(this.clear(),t){var n=this.getCtx(),r=n.measureText(t).width,o=P.Util.transformScreenXYWithDpr({x:e||0,y:i||0}),s=P.Util.getDpr();this.setTextBackground(o.x+4*s,o.y-16*s,r+7*s,20*s),this.setInitStyle(),n.fillText(t,o.x+7*s,o.y+1*s)}},setGeoText:function(t,e,i){if(this.clear(),t){var n=this.getCtx(),r=n.measureText(t).width,o=P.Util.worldToScreen(this._map,e||0,i||0),s=P.Util.transformScreenXYWithDpr(o),a=P.Util.getDpr();this.setTextBackground(s.x+4*a,s.y-16*a,r+7*a,20*a),this.setInitStyle(),n.fillText(t,s.x+7*a,s.y+1*a)}}}),P.Layer.Marker=P.Layer.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:20},this.id=t,this.oClass="markerLayer",this.oMarkers=[]},privateInitLayerContainer:function(t,e,i){var n=P.Util.createDiv(t,e,i,!0);this._layerContainer=n},addMarker:function(t){P.Util.isInArray(this.oMarkers,t)||(this.oMarkers.push(t),t.onAdd(this))},removeMarker:function(t){for(var e=[],i=0,n=0;i<this.oMarkers.length;i++)this.oMarkers[i]!==t?(e[n]=this.oMarkers[i],n++):this.oMarkers[i].onRemove(this);this.oMarkers=e,this.renew()},removeMarkerById:function(t){for(var e=[],i=0,n=this.oMarkers.length;i<n;i++){var r=this.oMarkers[i];r.id!==t?e.push(r):r.onRemove(this)}this.oMarkers=e,this.renew()},removeMarkersByIds:function(t){for(var e=[],i=[],n=0,r=this.oMarkers.length;n<r;n++){var o=this.oMarkers[n];t.includes(o.id)?(o.onRemove(this),i.push(o)):e.push(o)}return this.oMarkers=e,this.renew(),i},getAllMarkers:function(){return this.oMarkers},getMarkerById:function(t){for(var e=0;e<this.oMarkers.length;e++)if(this.oMarkers[e].id===t)return this.oMarkers[e];return null},addMarkers:function(t){for(var e=0;e<t.length;e++)this.addMarker(t[e])},removeMarkers:function(t){for(var e=t,i=e.length,n=0;n<i;n++){var r=e[n];this.removeMarker(r)}},removeAllMarkers:function(){var t=this.oMarkers;this.removeMarkers(t)},renew:function(){this._super();for(var t=0;t<this.oMarkers.length;t++)this.oMarkers[t].renew()},resize:function(){this._super(),this.renew()}}),P.Layer.Text=P.Layer.extend({init:function(t,e){this._super(t,e),this.options=e||{opacity:1,zIndex:19},this.id=t,this.oClass="textLayer",this.oTexts=[]},privateInitLayerContainer:function(t,e,i){var n=P.Util.createDiv(t,e,i,!0);this._layerContainer=n},addText:function(t){P.Util.isInArray(this.oTexts,t)||(this.oTexts.push(t),t.onAdd(this))},removeText:function(t){for(var e=[],i=0,n=0;i<this.oTexts.length;i++)this.oTexts[i]!==t?(e[n]=this.oTexts[i],n++):this.oTexts[i].onRemove(this);this.oTexts=e,this.renew()},getTextById:function(t){for(var e=0;e<this.oTexts.length;e++)if(this.oTexts[e].id===t)return this.oTexts[e];return null},removeTextById:function(t){for(var e=[],i=0,n=this.oTexts.length;i<n;i++){var r=this.oTexts[i];r.id!==t?e.push(r):r.onRemove(this)}this.oTexts=e,this.renew()},removeTextsByIds:function(t){for(var e=[],i=[],n=0,r=this.oTexts.length;n<r;n++){var o=this.oTexts[n];t.includes(o.id)?(o.onRemove(this),i.push(o)):e.push(o)}return this.oTexts=e,this.renew(),i},addTexts:function(t){for(var e=0;e<t.length;e++)this.addText(t[e])},removeTexts:function(t){for(var e=t,i=e.length,n=0;n<i;n++){var r=e[n];this.removeText(r)}},getAllTexts:function(){return this.oTexts},removeAllTexts:function(){this._layerContainer.innerHTML="",this.oTexts=[],this.renew()},renew:function(){this._super();for(var t=0;t<this.oTexts.length;t++)this.oTexts[t].renew()},resize:function(){this._super(),this.renew()}}),P});